---
title: "03-DA Care Totals"
output: html_document
date: "2023-06-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(sf)

DA_data_sf <- DA_census_data$geometry %>% st_as_sf()
dest_sf <- dest %>% 
  st_as_sf(coords = c("lon", "lat"), crs = 4326)

data_sf_summary <- DA_data_sf %>% 
  mutate(counts = lengths(st_intersects(., dest_sf)))
```

```{r}
sum(data_sf_summary$counts)
max(data_sf_summary$counts)
```

# Checking if points are outside the Hamilton Boundary

```{r}
library(sf)
library(ggplot2)

# Read the GeoJSON file containing the city boundaries
city_boundary <- st_read("City_Boundary.geojson")

# Convert the "dest" data frame to an sf object and assign the CRS
dest_sf <- st_as_sf(dest, coords = c("lon", "lat"), crs = 4326)

# Transform the destination points to match the CRS of the city boundaries
dest_sf <- st_transform(dest_sf, st_crs(city_boundary))

# Plot the city boundaries and the destination points
ggplot() +
  geom_sf(data = city_boundary, fill = "lightblue") +
  geom_sf(data = dest_sf, color = "red", size = 1) +
  theme_bw()

```

# Counting in the city boundaries
```{r}
library(sf)
library(leaflet)

# Read the GeoJSON file containing the city boundaries
city_boundary <- st_read("City_Boundary.geojson")

# Convert the geometry column of DA_selected_columns to an sf object
da_sf <- st_as_sf(DA_census_data, wkt = "geometry")

# Create an initial Leaflet map
map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron") # Use a tile provider for the base map

# Add the city boundaries to the map
map <- map %>%
  addPolygons(data = city_boundary, 
              fillColor = "lightgrey",
              fillOpacity = 0.7,
              color = "white",
              weight = 1)

# Add the dissemination area borders to the map
map <- map %>%
  addPolygons(data = da_sf, 
              fillColor = "transparent",
              color = "red",
              weight = 1)

# Add circle markers for the destinations
map <- map %>%
  addCircleMarkers(data = dest,
                   lat = ~lat,
                   lng = ~lon,
                   radius = 4,
                   fillColor = "green",
                   stroke = FALSE,
                   fillOpacity = 0.5,
                   popup = dest$id)

# Display the map
map
```
Error was found with 4 locations being missing from their respective DA's following code is changing those destination coordinates both in the FINAL_Care_Destinations_2023.csv and the dest_full data frame and then run the code again in the Travel Time Matrix to change it in the dest dataframe. 

# Adding the counts to the FIXED DA_census_data dataframe 

```{r}
library(sf)
library(dplyr)
land_use_data <- cbind(DA_census_data, counts = data_sf_summary$counts)
land_use_data <- land_use_data %>% 
  mutate(id = row_number()) %>%
  select(id, everything())
save("land_use_data", file = "data-tt/land_use_data.RDS")
```

