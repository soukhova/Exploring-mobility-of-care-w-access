---
title: "Exploring mobility of care with measures of accessibility"
author:
  - name: AAA #Anastasia Soukhov 
    email: AAA@AAA #soukhoa@mcmaster.ca
    affiliations:
        - name: McMaster University
          department: School of Earth, Environment & Society
          city: Hamilton
          state: Ontario, Canada
          postal-code: L8S 4L8
    attributes:
        corresponding: true
  - name: BBB #Nicholas Mooney
    email: BBB@BBB #mooneyn@mcmaster.ca 
    # affiliations:
    #     - name: McMaster University
    #       department: School of Earth, Environment & Society 
    #       city: Hamilton
    #       state: Ontario, Canada
    #       postal-code: L8S 4L8
  - name: CCC #LÃ©a Ravensbergen 
    email: CCC@CCC #ravensbl@mcmaster.ca 
    # affiliations:
    #     - name: McMaster University
    #       department: School of Earth, Environment & Society 
    #       city: Hamilton
    #       state: Ontario, Canada
    #       postal-code: L8S 4L8

abstract: |
  Accessibility, the ease of interacting with potential opportunities, is an increasingly important tool amongst transport planners aiming to foster equitable and sustainable cities. However, in accessibility research there is a historical focus on employment destinations that is shaped by a masculinist transportation planning tradition. This paper aims to counter this gendered bias by connecting the Mobility of Care framework, a gender-aware transport planning conceptualisation to an empirical accessibility analysis of care destinations in the City of Hamilton, Canada. Care destinations are all the places one must visit to sustain household needs such shopping, errands, and caring for others. This paper considers access to care across different modes of transport at two travel time thresholds (trips shorter than 15-minutes and 30-minutes) using a curated care destination dataset. The accessibility methods used includes the cumulative opportunities measure and a competitive and singly-constrained accessibility measure (spatial availability) for different modes. Overall, results indicate that accessibility by car is exceptionally high across the city, while access by public transit, cycling and foot is relatively low with some exceptions in the inner city. Notably, there are distinctions between both methods: cumulative opportunities illustrates a more optimistic potential interaction landscape for non-car modes, while the spatial availability measure demonstrates a theoretically more realistic spatial distribution of care destination availability of potential interaction. Neighbourhoods with both low spatial availability to care and a high proportion of low-income households are also identified and discussed as areas in need of intervention. The manuscript and analysis is computationally reproducible and openly available. The presented analysis demonstrates methods planners can use to apply a gender-aware lens to accessibility analysis. Further, results can inform policies aiming to encourage sustainable mobility.
  
keywords: 
  - Accessibility
  - Mobility of Care
  - Gender
  - Cumulative Opportunities
  - Spatial Availability
date: last-modified
bibliography: bibliography.bib
# csl: elsarticle.cls
format: 
  #docx
  elsevier-pdf:
    keep-tex: true
    include-in-header:
      text: |
        \usepackage{graphicx}
        \usepackage{unicode-math}
        \usepackage{hyperref}
        \def\tightlist{}
        \usepackage{setspace}
        \doublespacing
        \usepackage{lineno}
        \linenumbers
    journal:
      name: Journal of Transport Geography
      formatting: preprint
      model: 3p
      cite-style: authoryear
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      cache=FALSE)
```

```{r library-setup}
library(biscale)
library(cowplot)
library(sf)
library(here)
library(dplyr)
library(tmap)
library(mapview)
library(tmaptools)
library(pander)
library(flextable)
library(ftExtra)
library(scales)
library(ggplot2)
library(stringr)
library(renv)
```

```{r function-for-creating-comments-in-docx}
word_comment <- function(comment, highlight = "") {
  if (isTRUE(knitr:::pandoc_to() == "docx")) {
    paste0('[', comment, ']{.comment-start id="0" author="Anastasia"',
           'date="2024-01-06T15:00:00Z"}', highlight, '[]{.comment-end id="0"}')
  }
}
```

```{r, eval=FALSE}
#creates a bib file with R librarys used, will cite in manuscript
deps <- renv::dependencies()
pkgs <- setdiff(unique(deps$Package), "R")
bibtex::write.bib(entry = pkgs, file = "biliography_Rlibs.bib", append = FALSE)
#and manually added core R (citation()) and renv (citation("renv"))
```

```{r spatial-availability-function}
sp_avail_detailed <- function(x, o_id, d_id, pop, opp, r, f, alpha = 1){
  
  o_id <- rlang::enquo(o_id)
  d_id <- rlang::enquo(d_id)
  pop <- rlang::enquo(pop)
  opp <- rlang::enquo(opp)
  r <- rlang::enquo(r)
  f <- rlang::enquo(f)
  
  sum_pop <- x |>
    dplyr::distinct(!!o_id,
                    .keep_all = TRUE) |>
    dplyr::mutate(sum_pop = !!r*(!!pop)^alpha) |>
    dplyr::pull(sum_pop) |>
    sum()
  
  f_p <- dplyr::pull(x, !!r) * dplyr::pull(x, !!pop)^alpha / sum_pop
  
  sum_impedance <- x |>
    dplyr::group_by(!!d_id) |>
    dplyr::summarize(sum_impedance = sum(!!f))
  
  x <- x |>
    dplyr::left_join(sum_impedance,
                     by = rlang::as_name(d_id))
  
  f_c <- dplyr::pull(x, !!f) / x$sum_impedance
  
  x$f_c <- f_c
  x$f_p <- f_p
  
  sum_pa <- x |>
    dplyr::group_by(!!d_id) |>
    dplyr::summarize(sum_pa= sum(f_p * f_c))
  
  x <- x |>
    dplyr::left_join(sum_pa,
                     by = rlang::as_name(d_id))
  x$f_t <- (f_p * f_c) / dplyr::pull(x, sum_pa)
  
  x |>
    dplyr::mutate(V_ij = !!opp * f_t)
}
```

```{r import-data, message=FALSE, warning=FALSE}
#boundaries for mapping
hamilton_communities <- st_read(paste0(here::here(),"/data-raw/Boundaries/Community_Boundaries.shp"), quiet = TRUE) |> mutate(COMMUNITY_ = ifelse(COMMUNITY_ == "Hamilton", "Hamilton-Central", COMMUNITY_))
ham_bound <- st_read(paste0(here::here(),"/data-raw/Boundaries/City_Boundary.shp"), quiet = TRUE)

hydro_p_LakeOntario <- st_read(paste0(here::here(),"/data-raw/Boundaries/hydro_p_LakeOntario.shp"), quiet = TRUE) |> st_transform(crs=4326)
ham_bay <- st_read(paste0(here::here(),"/data-raw/Boundaries/Waterbodies.shp"), quiet = TRUE) |> st_transform(crs=4326) |> filter(FEATURE_TY == "Lake")
ham_streets <- st_read(paste0(here::here(),"/data-raw/Boundaries/Street_Centreline.shp"), quiet = TRUE) |> st_transform(crs=4326) |> filter(ROAD_CLASS %in% c("Provincial Highway", "Parkway", "Arterial")) #no collectors, arterial, Local

#opportunities and population dataset 
base::load(paste0(here::here(),"/data-intermediate/care_dest.rda"))
care_dest <- care_dest |> mutate(ID = as.character(ID))
base::load(paste0(here::here(),"/data-intermediate/HAM_census_21.rda"))
HAM_census_21 <- HAM_census_21 |>
  rename("LICO_AT_TOTAL" = `v_CA21_1085: Prevalence of low income based on the Low-income cut-offs, after tax (LICO-AT) (%)`) |> 
  mutate(LICO_AT_TOTAL = ifelse(is.na(LICO_AT_TOTAL), 0, LICO_AT_TOTAL)) |>
  rowwise() |> mutate(
         perc_walked = (`v_CA21_7647: Walked`)/sum(`v_CA21_7647: Walked`,`v_CA21_7635: Car, truck or van`, `v_CA21_7644: Public transit`,`v_CA21_7650: Bicycle`, `v_CA21_7653: Other method`, na.rm=TRUE),
         perc_car = (`v_CA21_7635: Car, truck or van`)/sum(`v_CA21_7647: Walked`,`v_CA21_7635: Car, truck or van`, `v_CA21_7644: Public transit`,`v_CA21_7650: Bicycle`, `v_CA21_7653: Other method`, na.rm=TRUE),
perc_transit = (`v_CA21_7644: Public transit`)/sum(`v_CA21_7647: Walked`,`v_CA21_7635: Car, truck or van`, `v_CA21_7644: Public transit`,`v_CA21_7650: Bicycle`, `v_CA21_7653: Other method`, na.rm=TRUE),
 perc_cycle_other = (`v_CA21_7650: Bicycle`+ `v_CA21_7653: Other method`)/sum(`v_CA21_7647: Walked`,`v_CA21_7635: Car, truck or van`, `v_CA21_7644: Public transit`,`v_CA21_7650: Bicycle`, `v_CA21_7653: Other method`, na.rm=TRUE),
pop_den = Population/`Shape Area`) |>
  select(c("GeoUID", "Population", "LICO_AT_TOTAL", "perc_walked", "perc_car", "perc_transit", "perc_cycle_other", "pop_den"))

base::load(paste0(here::here(),"/data-intermediate/HAM_census_16.rda"))
HAM_census_16 <- HAM_census_16 |>
  rename("LICO_AT_TOTAL" = `v_CA16_2570: Prevalence of low income based on the Low-income cut-offs, after tax (LICO-AT) (%)`) |> 
  mutate(LICO_AT_TOTAL = ifelse(is.na(LICO_AT_TOTAL), 0, LICO_AT_TOTAL)) |>
  rowwise() |> mutate(
    perc_walked = (`v_CA16_5804: Walked`)/sum(`v_CA16_5804: Walked`,`v_CA16_5795: Car, truck, van - as a driver`, `v_CA16_5798: Car, truck, van - as a passenger`,`v_CA16_5801: Public transit`,`v_CA16_5807: Bicycle`, `v_CA16_5810: Other method`, na.rm=TRUE),
    perc_car = sum(`v_CA16_5795: Car, truck, van - as a driver`, `v_CA16_5798: Car, truck, van - as a passenger`)/sum(`v_CA16_5804: Walked`,`v_CA16_5795: Car, truck, van - as a driver`, `v_CA16_5798: Car, truck, van - as a passenger`,`v_CA16_5801: Public transit`,`v_CA16_5807: Bicycle`, `v_CA16_5810: Other method`, na.rm=TRUE),
    perc_transit = (`v_CA16_5801: Public transit`)/sum(`v_CA16_5804: Walked`,`v_CA16_5795: Car, truck, van - as a driver`, `v_CA16_5798: Car, truck, van - as a passenger`,`v_CA16_5801: Public transit`,`v_CA16_5807: Bicycle`, `v_CA16_5810: Other method`, na.rm=TRUE),
    perc_cycle_other = (`v_CA16_5807: Bicycle`+ `v_CA16_5810: Other method`)/sum(`v_CA16_5804: Walked`,`v_CA16_5795: Car, truck, van - as a driver`, `v_CA16_5798: Car, truck, van - as a passenger`,`v_CA16_5801: Public transit`,`v_CA16_5807: Bicycle`, `v_CA16_5810: Other method`, na.rm=TRUE),
pop_den = Population/`Shape Area`) |>
  select(c("GeoUID", "Population", "LICO_AT_TOTAL", "perc_walked", "perc_car", "perc_transit", "perc_cycle_other", "pop_den"))
```

```{r import-data2, message=FALSE, include=FALSE}
# #add GeoUIDs to parcel id list
# base::load(paste0(here::here(),"/data-raw/R_PARCELS_CENTS_2020.rda")) #add the census id to the parcels, then the ttm
# 
# #first join it to census. Transfer the GeoUID from the DAs that intersect with the residential land use parcel centroids to the R_PARCELS_CENTS_2020 sf object. (we use 'over' here instead of st_intersection because it is way faster)
# R_PARCELS_CENTS_GeoUIDs <- sp::over(as_Spatial(R_PARCELS_CENTS_2020),as_Spatial(HAM_census_21 |> dplyr::select(GeoUID)))
# 
# R_PARCELS_CENTS_GeoUIDs_IDs <- cbind(R_PARCELS_CENTS_GeoUIDs, R_PARCELS_CENTS_2020 |> dplyr::select("ID") |> st_drop_geometry()) |> 
#   mutate(ID = as.character(ID),
#          GeoUID = as.character(GeoUID))
```

```{r import-data3, message=FALSE, include=FALSE}
# #calculated travel times - bike
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_bike_parcel1.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_bike_parcel2.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_bike_parcel3.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_bike_parcel4.rda"))
# 
# ttm_care_bike_parcel <- rbind(ttm_care_bike_parcel1, ttm_care_bike_parcel2, ttm_care_bike_parcel3, ttm_care_bike_parcel4)
# rm(ttm_care_bike_parcel1, ttm_care_bike_parcel2, ttm_care_bike_parcel3, ttm_care_bike_parcel4)
# 
# ttm_care_bike_parcel_all <- left_join(ttm_care_bike_parcel, 
#                                    care_dest |> st_drop_geometry() |> select(c("ID","Care_Category")),
#                                    by=c("to_id" = "ID")) |> mutate(weight = 1) |>
#   left_join(R_PARCELS_CENTS_GeoUIDs_IDs,by = c("from_id"="ID") )
# 
# 
# #walk
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_walk_parcel1.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_walk_parcel2.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_walk_parcel3.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_walk_parcel4.rda"))
# 
# ttm_care_walk_parcel <- rbind(ttm_care_walk_parcel1, ttm_care_walk_parcel2, ttm_care_walk_parcel3, ttm_care_walk_parcel4)
# rm(ttm_care_walk_parcel1, ttm_care_walk_parcel2, ttm_care_walk_parcel3, ttm_care_walk_parcel4)
# 
# ttm_care_walk_parcel_all <- left_join(ttm_care_walk_parcel, 
#                                    care_dest |> st_drop_geometry() |> select(c("ID","Care_Category")),
#                                    by=c("to_id" = "ID")) |> mutate(weight = 1) |>
#   left_join(R_PARCELS_CENTS_GeoUIDs_IDs,by = c("from_id"="ID") )
# 
# #car times
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_CAR_parcel1.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_CAR_parcel2.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_CAR_parcel3.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_CAR_parcel4.rda"))
# 
# ttm_care_car_parcel <- rbind(ttm_care_CAR_parcel1, ttm_care_CAR_parcel2, ttm_care_CAR_parcel3, ttm_care_CAR_parcel4)
# rm(ttm_care_CAR_parcel1, ttm_care_CAR_parcel2, ttm_care_CAR_parcel3, ttm_care_CAR_parcel4)
# 
# ttm_care_car_parcel_all <- left_join(ttm_care_car_parcel, 
#                                    care_dest |> st_drop_geometry() |> select(c("ID","Care_Category")),
#                                    by=c("to_id" = "ID")) |> mutate(weight = 1) |>
#   left_join(R_PARCELS_CENTS_GeoUIDs_IDs,by = c("from_id"="ID") )
# 
# #transit times
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_TRANSIT_parcel1.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_TRANSIT_parcel2.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_TRANSIT_parcel3.rda"))
# base::load(paste0(here::here(),"/data-intermediate/parcel_tts/ttm_care_TRANSIT_parcel4.rda"))
# 
# ttm_care_transit_parcel <- rbind(ttm_care_TRANSIT_parcel1, ttm_care_TRANSIT_parcel2, ttm_care_TRANSIT_parcel3, ttm_care_TRANSIT_parcel4)
# rm(ttm_care_TRANSIT_parcel1, ttm_care_TRANSIT_parcel2, ttm_care_TRANSIT_parcel3, ttm_care_TRANSIT_parcel4)
# 
# ttm_care_transit_parcel_all <- left_join(ttm_care_transit_parcel, 
#                                    care_dest |> st_drop_geometry() |> select(c("ID","Care_Category")),
#                                    by=c("to_id" = "ID")) |> mutate(weight = 1) |>
#   left_join(R_PARCELS_CENTS_GeoUIDs_IDs,by = c("from_id"="ID") )
```

```{r import-data4, message=FALSE}
#calculated travel times - bike
base::load(paste0(here::here(),"/data-intermediate/ttm_care_bike.rda"))
base::load(paste0(here::here(),"/data-intermediate/ttm_care_car.rda"))
base::load(paste0(here::here(),"/data-intermediate/ttm_care_transit.rda"))
base::load(paste0(here::here(),"/data-intermediate/ttm_care_walk.rda"))
```

<!-- NOTE: created new Figure 1 in "00-Data-Preparation.RMD" as it requires the r5_core street network-->
```{r creating-fig1, eval=FALSE}
# # Plot the map with different colors for each community and the transit lines layer
# plot_hamilton_boundaries <- #first the lakes and streets
#   tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
#   tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
#   #next the hamilton community boundary layer 1, the streets, then community boundary 2 (black borders)
#   tm_shape(hamilton_communities, bbox=hamilton_communities) +
#   tm_polygons("COMMUNITY_",  palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"), title = "Hamilton Communities")+ #palette from (viridis::viridis(8))
#   tm_shape(ham_streets) + tm_lines(col="lightgrey", lwd=0.5) +
#   tm_shape(hamilton_communities, bbox=hamilton_communities) +
#   tm_polygons(alpha=0, border.col = "black", lwd=1)+
#   #next the text for the communities and then the scale bar, compass, and instruction for legend position
#   tm_text(text = "COMMUNITY_", size = 1.25, col = "black", shadow = TRUE) +
#   tm_scale_bar(position = c("left", "bottom"), breaks = c(0, 1, 5, 10, 20)) +
#   tm_compass(position = c("left", "top"), size = 1.0) +
#   tm_layout(bg.color = "grey", legend.position = c("right","top"))
# 
# plot_hamilton_boundaries
# tmap_save(plot_hamilton_boundaries, filename ="figures/Fig1-boundaries.png", dpi=600)
```

```{r reformat care-dest specific categories}
care_dest <- care_dest |> 
  mutate(Care_Category_Specific = case_when(
    Care_Category_Specific  == "Daycare_EarlyON" ~ "EarlyON Daycare",
    Care_Category_Specific == "Community_Centre" ~ "Community Centre",
    Care_Category_Specific == "Daycare_Centre" ~ "Daycare",
    Care_Category_Specific == "Recreation_Centre" ~ "Recreation Centre",
    Care_Category_Specific == "School" ~ "School",
    Care_Category_Specific == "Long-Term_Care_Home" ~ "Long-Term Care Home",
    Care_Category_Specific == "Retirement_Home" ~ "Retirement Home",
    Care_Category_Specific == "Senior_Centre" ~ "Senior Centre",
    Care_Category_Specific == "Seniors_Active_Living_Centre" ~ "Seniors Active Living Centre",
    Care_Category_Specific == "Post_Office" ~ "Post Office",
    Care_Category_Specific == "Library" ~ "Library",
    Care_Category_Specific == "Banks" ~ "Banks",
    Care_Category_Specific == "Grocer_ConvenienceStore" ~ "Convenience Store",
    Care_Category_Specific == "Clinics" ~ "Clinics",
    Care_Category_Specific == "Grocer_Retail" ~ "Grocer",
    Care_Category_Specific == "Dentist" ~ "Dentist",
    Care_Category_Specific == "Hosptial" ~ "Hosptial",
    Care_Category_Specific == "Pharmacy" ~ "Pharmacy",
    Care_Category_Specific == "Park" ~ "Park"
  )) 
```

```{r creating-fig2s, eval=FALSE}
# Plot the map with the opportunity types
plot_care_categories <- 
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(hamilton_communities, bbox=hamilton_communities) + tm_polygons(col = "white", border.col = "black", lwd=1)+
  tm_shape(care_dest) + tm_dots("Care_Category_Specific", palette = RColorBrewer::brewer.pal(n = 6, name = 'Dark2'), size=0.025, title = "")+
  tm_facets("Care_Category", nrow = 3, free.scales= TRUE)+
  tm_scale_bar(position = c("left", "bottom"), breaks = c(0, 1, 5, 10, 20)) +
  tm_compass(position = c("left", "top"), size=0.9) +
  tm_layout(bg.color = "grey", panel.label.bg.color = "white", legend.position = c("right", "top"), legend.text.size = 0.5, legend.bg.color = "white", legend.bg.alpha = 0.4,
            panel.labels = c("1,190 Child-centric destinations", 
                             "75 Elder-centric destinations", 
                             "158 Errand-centric destinations", 
                             "381 Grocery-centric destinations", 
                             "421 Health-centric destinations"),
            panel.label.size = 0.8) 
plot_care_categories

tmap_save(plot_care_categories, filename ="figures/Fig2-plot_care_categories.png")
```
```{r}
# plot_care_categories <- image_read("figures/Fig2-plot_care_categories.png")
# magick::image_scale(plot_care_categories, "100") |> 
#   image_write("figures/Fig2-plot_care_categories.png")
```
```{r creating-backgrounds-for-ggplots}
ham_bay <- ham_bay |> st_transform(crs=4326)
hamilton_communities <- hamilton_communities  |> st_transform(crs=4326)
hydro_p_LakeOntario <- hydro_p_LakeOntario  |> st_transform(crs=4326)

ham_bay_cropped<-st_crop(ham_bay$geometry, hamilton_communities$geometry)
hydro_p_LakeOntario_cropped<-st_crop(hydro_p_LakeOntario$geometry, hamilton_communities$geometry)
```

```{r creating-fig3, eval=FALSE}
plot_all_pop <- ggplot() +
  geom_sf(data = ham_bay_cropped, colour = NA, fill = "skyblue")+
  geom_sf(data = hydro_p_LakeOntario_cropped, colour = NA, fill = "skyblue")+
  geom_sf(data = HAM_census_21, mapping = aes(fill = Population),
          colour = NA, size = 0.1) +
  scale_fill_fermenter(
    palette = "Greys",
    direction = 1,
    breaks = c(0.0001, 441 ,521    ,664   ,7631 ),
    labels = c("\n0","\n>0 to <441", "\n441 to <521", "\n521 to <664", "\n664 to 7631"),
    name = "Population",
    guide = guide_legend(direction = "horizontal", title.position = "top",
                             label.position="bottom")) +
  geom_sf(data=hamilton_communities, colour = "black", fill=NA) +
  ggspatial::annotation_scale(
    location = "tl",
    height = unit(0.1, "cm")) +
  theme_void()+
  theme(legend.text=element_text(size=8, vjust=5),
        legend.position = "bottom",
        legend.key.size = unit(2, 'mm'),
        plot.background=element_rect(fill="transparent", color = NA),
        panel.background=element_rect(fill="transparent", color = NA),
        panel.border = element_rect(colour = "black", fill= NA, size=0.5))

#creating the LICO Vs. Pop-density map
bi_data <- bi_class(HAM_census_21, 
                 x = pop_den, 
                 y = LICO_AT_TOTAL,
                 style = "quantile", 
                 dim = 3)

plot_low_income_density_pops <- ggplot() +
  geom_sf(data = ham_bay_cropped, colour = NA, fill = "skyblue")+
  geom_sf(data = hydro_p_LakeOntario_cropped, colour = NA, fill = "skyblue")+
  geom_sf(data = bi_data, mapping = aes(fill = bi_class), 
          color = NA, size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "PurpleOr", dim = 3) +
  bi_theme()+
  geom_sf(data=hamilton_communities, colour = "black", fill=NA) +
  ggspatial::annotation_scale(
    location = "tl",
    height = unit(0.1, "cm")) +
  theme_void()+
  theme(legend.position='right',
        panel.background=element_rect(fill="transparent", color = NA),
        panel.border = element_rect(colour = "black", fill="transparent", size=0.5),
        plot.margin = margin(t = 0,  # Top margin
                             r = 0,  # Right margin
                             b = 49,  # Bottom margin
                             l = 0))
plot_low_income_density_pops
bi_legend_plot <- bi_legend(pal = "PurpleOr",
                    dim = 3,
                    xlab = "Pop. density",
                    ylab = "LICO-AT % ",
                    size = 8,
                    pad_color = "transparent")

#the final plot with both maps all put together
cowplot::ggdraw() +
  cowplot::draw_plot(bi_legend_plot, 0.4, .3, 0.2, 0.2) +
  cowplot::draw_plot(plot_low_income_density_pops, 0.5, 0, 0.5, 1) +
  cowplot::draw_plot(plot_all_pop, 0, 0, 0.5, 1)

ggsave(file="figures/Fig3-plot_pops.png", dpi=600)
```

```{r augmenting the hamilton census object with modal splits}
#creating an object with modal splits
HAM_census_21_walk <- HAM_census_21 |> 
  mutate(perc_mode = ifelse(is.na(perc_walked), 0, 100*(perc_walked)),
         mode = "Walk")
HAM_census_21_car <- HAM_census_21 |> 
  mutate(perc_mode = ifelse(is.na(perc_car), 0, 100*(perc_car)),
         mode = "Car")
HAM_census_21_transit <- HAM_census_21 |> 
  mutate(perc_mode = ifelse(is.na(perc_transit), 0, 100*(perc_transit)),
         mode = "Transit")
HAM_census_21_cycle <- HAM_census_21 |> 
  mutate(perc_mode = ifelse(is.na(perc_cycle_other), 0, 100*(perc_cycle_other)),
         mode = "Cycle and other")
HAM_census_21_long <- rbind(HAM_census_21_walk, HAM_census_21_car, HAM_census_21_transit, HAM_census_21_cycle)
rm(HAM_census_21_walk, HAM_census_21_car, HAM_census_21_transit, HAM_census_21_cycle)
```

```{r plotting modal splits pop distribution, eval=FALSE}
plot_modal_splits <- tm_shape(ham_bay, bbox=hamilton_communities) + 
  tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) +
  tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_census_21_long |> filter(perc_mode > 0)) +
  tm_polygons("perc_mode", palette = "RdYlGn", border.col = NULL, breaks =
                c(1,10,20,30,40, 50, 60,70,80,90,100), style="cont", midpoint=50, legend.is.portrait=FALSE, title = "Population %")+
  tm_facets("mode", free.scales = FALSE)+
  tm_shape(hamilton_communities, bbox=hamilton_communities) +
  tm_polygons(alpha=0, border.col = "black", lwd=1)+
  tm_scale_bar(position = c("left", "bottom"), breaks = c(0, 1, 5, 10, 20)) +
  tm_compass(position = c("right", "top"), size = 1.0) +
  tm_layout(bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            legend.outside = TRUE,
            legend.outside.position = "bottom",
            legend.position = c("center", "bottom"),
            legend.outside.size = 0.12)
plot_modal_splits
tmap_save(plot_modal_splits, filename ="figures/Fig4-plot_modal_splits.png", dpi=600)
```

```{r 30 min cumulative opps}
# the cumulative opp count for the number of care opportunities that can be reached within 30 mins or less:
ttm_car_30 <- ttm_care_car |> 
  filter(travel_time_p50 <= 30) |>
  group_by(from_id) |> 
  summarise(cum_opps = n())

ttm_walk_30 <- ttm_care_walk |> 
  filter(travel_time_p50 <= 30) |>
  group_by(from_id) |> 
  summarise(cum_opps = n())

ttm_bike_30 <- ttm_care_bike |>
  filter(travel_time_p50 <= 30) |>
  group_by(from_id) |> 
  summarise(cum_opps = n())

ttm_transit_30 <- ttm_care_transit |>
  filter(travel_time_p25 <= 30) |>
  group_by(from_id) |> 
  summarise(cum_opps = n())
```


```{r 15 min cumulative opps}
#15 mins or less
ttm_car_15_cats <- ttm_care_car |> merge(care_dest |> st_drop_geometry() |> select(c("ID", "Care_Category")), by.x = "to_id", by.y = "ID") |>
  filter(travel_time_p50 <= 15) |>
  group_by(from_id,Care_Category) |> 
  summarise(cum_opps = n())

ttm_walk_15_cats <- ttm_care_walk |> merge(care_dest |> st_drop_geometry() |> select(c("ID", "Care_Category")), by.x = "to_id", by.y = "ID") |>
  filter(travel_time_p50 <= 15) |>
  group_by(from_id,Care_Category) |> 
  summarise(cum_opps = n())

ttm_bike_15_cats <- ttm_care_bike |> merge(care_dest |> st_drop_geometry() |> select(c("ID", "Care_Category")), by.x = "to_id", by.y = "ID") |>
  filter(travel_time_p50 <= 15) |>
  group_by(from_id,Care_Category) |> 
  summarise(cum_opps = n())

ttm_transit_15_cats <- ttm_care_transit |> merge(care_dest |> st_drop_geometry() |> select(c("ID", "Care_Category")), by.x = "to_id", by.y = "ID") |>
  filter(travel_time_p25 <= 15) |>
  group_by(from_id,Care_Category) |> 
  summarise(cum_opps = n())

ttm_car_15 <- ttm_car_15_cats |> group_by(from_id) |> summarise(cum_opps = sum(cum_opps))
ttm_walk_15 <- ttm_walk_15_cats |> group_by(from_id) |> summarise(cum_opps = sum(cum_opps))
ttm_bike_15 <- ttm_bike_15_cats |> group_by(from_id) |> summarise(cum_opps = sum(cum_opps))
ttm_transit_15 <- ttm_transit_15_cats |> group_by(from_id) |> summarise(cum_opps = sum(cum_opps))
```

```{r 30 min and 15 min cumulative opps part 2}
#attaching the cum opps to sf object for mapping. ALL CATEGORIES. First the 30 mins.
HAM_access_30_1 <- HAM_census_21 |>
  merge(ttm_car_30, by.x="GeoUID", by.y="from_id", all.x=TRUE) |>
  mutate(mode = "a_car")

HAM_access_30_2 <-HAM_census_21 |>
  merge(ttm_transit_30, by.x="GeoUID", by.y="from_id",all.x=TRUE) |>
  mutate(mode = "b_transit")

HAM_access_30_3 <-HAM_census_21 |>
  merge(ttm_bike_30, by.x="GeoUID", by.y="from_id", all.x=TRUE) |>
  mutate(mode = "c_bike")

HAM_access_30_4 <-HAM_census_21 |>
  merge(ttm_walk_30, by.x="GeoUID", by.y="from_id", all.x=TRUE) |>
  mutate(mode = "d_walk")

HAM_access_30 <- rbind(HAM_access_30_1, HAM_access_30_2, HAM_access_30_3, HAM_access_30_4) |>
  mutate(cum_opps = ifelse(is.na(cum_opps), 0, cum_opps))

base::remove(HAM_access_30_1,HAM_access_30_2,HAM_access_30_3,HAM_access_30_4)

# the 15 mins
HAM_access_15_1 <- HAM_census_21 |>
  merge(ttm_car_15, by.x="GeoUID", by.y="from_id", all.x=TRUE) |>
  mutate(mode = "a_car")

HAM_access_15_2 <-HAM_census_21 |>
  merge(ttm_transit_15, by.x="GeoUID", by.y="from_id",all.x=TRUE) |>
  mutate(mode = "b_transit")

HAM_access_15_3 <-HAM_census_21 |>
  merge(ttm_bike_15, by.x="GeoUID", by.y="from_id", all.x=TRUE) |>
  mutate(mode = "c_bike")

HAM_access_15_4 <-HAM_census_21 |>
  merge(ttm_walk_15, by.x="GeoUID", by.y="from_id", all.x=TRUE) |>
  mutate(mode = "d_walk")

HAM_access_15 <- rbind(HAM_access_15_1, HAM_access_15_2, HAM_access_15_3, HAM_access_15_4) |>
  mutate(cum_opps = ifelse(is.na(cum_opps), 0, cum_opps))


# 15 mins -- with categories -- this is for inspection. 
HAM_access_15_1 <- HAM_census_21 |>
  merge(ttm_car_15_cats, by.x="GeoUID", by.y="from_id", all.x=TRUE) |>
  mutate(mode = "a_car")

HAM_access_15_2 <-HAM_census_21 |>
  merge(ttm_transit_15_cats, by.x="GeoUID", by.y="from_id",all.x=TRUE) |>
  mutate(mode = "b_transit")

HAM_access_15_3 <-HAM_census_21 |>
  merge(ttm_bike_15_cats, by.x="GeoUID", by.y="from_id", all.x=TRUE) |>
  mutate(mode = "c_bike")

HAM_access_15_4 <-HAM_census_21 |>
  merge(ttm_walk_15_cats, by.x="GeoUID", by.y="from_id", all.x=TRUE) |>
  mutate(mode = "d_walk")

HAM_access_15_cats <- rbind(HAM_access_15_1, HAM_access_15_2, HAM_access_15_3, HAM_access_15_4) |>
  mutate(cum_opps = ifelse(is.na(cum_opps), 0, cum_opps))
base::remove(HAM_access_15_1,HAM_access_15_2,HAM_access_15_3,HAM_access_15_4)
```

```{r calcing spatial availability part one}
# here I calculate the proportion of population taking each mode and their 'f' (1 if travel time is under 30 mins or 15 mins). I do 30 min first. Then 15 min. I stack all these objects togther and use this object to later calc spatial availability. 
ttm_car_30 <- ttm_care_car |>
  mutate(f = ifelse(travel_time_p50 <= 30, 1, 0)) |>
  merge(HAM_access_30 |> st_drop_geometry() |> filter(mode == "a_car") |> select(c("GeoUID", "Population", "perc_car", "mode")), by.x = "from_id", by.y = "GeoUID") |>
  mutate(Population = Population*perc_car) |> select(-c("perc_car"))

ttm_walk_30 <- ttm_care_walk |>
  mutate(f = ifelse(travel_time_p50 <= 30, 1, 0)) |>
  merge(HAM_access_30 |> st_drop_geometry() |> filter(mode == "d_walk") |> select(c("GeoUID", "Population", "perc_walked", "mode")), by.x = "from_id", by.y = "GeoUID") |>
  mutate(Population = Population*perc_walked) |> select(-c("perc_walked"))

ttm_bike_30 <- ttm_care_bike |> 
  mutate(f = ifelse(travel_time_p50 <= 30, 1, 0) #,Dest_count = 1
         ) |>
  merge(HAM_access_30 |> st_drop_geometry() |> filter(mode == "c_bike") |> select(c("GeoUID", "Population", "perc_cycle_other", "mode")), by.x = "from_id", by.y = "GeoUID") |>
  mutate(Population = Population*perc_cycle_other) |> select(-c("perc_cycle_other"))

ttm_transit_30 <- ttm_care_transit |> 
  mutate(f = ifelse(travel_time_p25 <= 30, 1, 0) #,Dest_count = 1
         ) |>
  merge(HAM_access_30 |> st_drop_geometry() |> filter(mode == "b_transit") |> select(c("GeoUID", "Population", "perc_transit", "mode")), by.x = "from_id", by.y = "GeoUID") |>
  mutate(Population = Population*perc_transit) |> select(-c("perc_transit"))

#15 mins or less
ttm_car_15 <- ttm_care_car |>
  mutate(f = ifelse(travel_time_p50 <= 15, 1, 0) #,Dest_count = 1
         ) |>
  merge(HAM_access_15 |> st_drop_geometry() |> filter(mode == "a_car") |> select(c("GeoUID", "Population", "perc_car", "mode")), by.x = "from_id", by.y = "GeoUID")|>
  mutate(Population = Population*perc_car) |> select(-c("perc_car"))

ttm_walk_15 <- ttm_care_walk |> 
  mutate(f = ifelse(travel_time_p50 <= 15, 1, 0) #,Dest_count = 1
         ) |>
  merge(HAM_access_15 |> st_drop_geometry() |> filter(mode == "d_walk") |> select(c("GeoUID", "Population", "perc_walked", "mode")), by.x = "from_id", by.y = "GeoUID")|>
  mutate(Population = Population*perc_walked) |> select(-c("perc_walked"))

ttm_bike_15 <- ttm_care_bike |> 
  mutate(f = ifelse(travel_time_p50 <= 15, 1, 0) #,Dest_count = 1
         ) |>
  merge(HAM_access_15 |> st_drop_geometry() |> filter(mode == "c_bike") |> select(c("GeoUID", "Population", "perc_cycle_other", "mode")), by.x = "from_id", by.y = "GeoUID")|>
  mutate(Population = Population*perc_cycle_other) |> select(-c("perc_cycle_other"))

ttm_transit_15 <- ttm_care_transit |> 
  mutate(f = ifelse(travel_time_p25 <= 15, 1, 0) #,Dest_count = 1
         ) |>
  merge(HAM_access_15 |> st_drop_geometry() |> filter(mode == "b_transit") |> select(c("GeoUID", "Population", "perc_transit", "mode")), by.x = "from_id", by.y = "GeoUID")|>
  mutate(Population = Population*perc_transit) |> select(-c("perc_transit"))

ttm_ALL_30 <- rbind(ttm_car_30, ttm_walk_30, ttm_bike_30,ttm_transit_30) |>
  mutate(Population = ifelse(is.na(Population), 0, Population))
rm(ttm_car_30, ttm_walk_30, ttm_bike_30,ttm_transit_30)

ttm_ALL_15 <- rbind(ttm_car_15, ttm_walk_15, ttm_bike_15,ttm_transit_15) |>
  mutate(Population = ifelse(is.na(Population), 0, Population))
rm(ttm_car_15, ttm_walk_15, ttm_bike_15,ttm_transit_15)
```

```{r sp-test-pt1, eval=FALSE}
# HERE we try an neg exponential distance decay function instead of a binary 1/0 function... rapidly decreasing after 15 mins or less. The resulting plot appears to show similar trends as 
ttm_car_15_1 <- ttm_care_car |>
  mutate(f = dexp(travel_time_p50,rate = 0.25)
         ) |>
  merge(HAM_access_15 |> st_drop_geometry() |> filter(mode == "a_car") |> select(c("GeoUID", "Population", "perc_car", "mode")), by.x = "from_id", by.y = "GeoUID")|>
  mutate(Population = Population*perc_car) |> select(-c("perc_car"))

ttm_walk_15_1 <- ttm_care_walk |> 
  mutate(f = dexp(travel_time_p50,rate = 0.25)
         ) |>
  merge(HAM_access_15 |> st_drop_geometry() |> filter(mode == "d_walk") |> select(c("GeoUID", "Population", "perc_walked", "mode")), by.x = "from_id", by.y = "GeoUID")|>
  mutate(Population = Population*perc_walked) |> select(-c("perc_walked"))

ttm_bike_15_1 <- ttm_care_bike |> 
  mutate(f = dexp(travel_time_p50,rate = 0.25)
         ) |>
  merge(HAM_access_15 |> st_drop_geometry() |> filter(mode == "c_bike") |> select(c("GeoUID", "Population", "perc_cycle_other", "mode")), by.x = "from_id", by.y = "GeoUID")|>
  mutate(Population = Population*perc_cycle_other) |> select(-c("perc_cycle_other"))

ttm_transit_15_1 <- ttm_care_transit |> 
  mutate(f = dexp(travel_time_p25,rate = 0.25)
         ) |>
  merge(HAM_access_15 |> st_drop_geometry() |> filter(mode == "b_transit") |> select(c("GeoUID", "Population", "perc_transit", "mode")), by.x = "from_id", by.y = "GeoUID")|>
  mutate(Population = Population*perc_transit) |> select(-c("perc_transit"))

ttm_ALL_15_1 <- rbind(ttm_car_15_1, ttm_walk_15_1, ttm_bike_15_1, ttm_transit_15_1) |>
  mutate(Population = ifelse(is.na(Population), 0, Population))
rm(ttm_car_15_1, ttm_walk_15_1, ttm_bike_15_1, ttm_transit_15_1)

Savail_BYMODE_15_1 <- ttm_ALL_15_1 |>
  mutate(catch = 1) |>
  sp_avail_detailed(o_id = from_id, d_id = to_id, pop = Population, opp = catch, r = catch, f = f, alpha = 1)|>
  group_by(from_id, mode) |> summarize(V_im = sum(V_ij, na.rm = TRUE))

Savail_BYMODE_15_1$V_im |> sum() #sums to 2225 opportunities

# the 15 mins
HAM_access_15_1 <- HAM_access_15 |> 
  merge(Savail_BYMODE_15_1, by.x = c("GeoUID", "mode"),by.y = c("from_id", "mode"), all.x=TRUE) |>
  mutate(V_im = ifelse(is.na(V_im), 0, V_im),
         v_im = case_when(mode == "a_car" ~ V_im/(Population*perc_car),
                                  mode == "c_bike" ~ V_im/(Population*perc_cycle_other),
                                  mode == "d_walk" ~ V_im/(Population*perc_walked),
                                  mode == "b_transit" ~ V_im/(Population*perc_transit)),
         v_im = ifelse(is.nan(v_im)| is.na(v_im), 0, v_im))

HAM_access_15_1$V_im |> sum(na.rm=TRUE) #sums to 2225 opportunities

plot_Savail_15m_1 <-
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_access_15_1) +
  tm_polygons("V_im",
              palette = "Greens",
              breaks = c(0, 0.000000001, 0.002064  , 0.100226 , 11.813501 ),
              labels = c("Q1: 0", "Q2: 0 to 0.002", "Q3: 0.002 to 0.13", "Q4: 0.13 to 14.14"),
              border.alpha = 0,
              title = expression(V[i]^m)) +
  tm_facets(by=c("mode"), nrow=1, showNA = FALSE)+
  tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
  tm_layout(main.title = "Spatially available to mode-using population within 15 mins",
            main.title.size = 0.8,
            panel.show = FALSE,
            panel.labels=c("Car","Transit","Bike","Walk"),
            bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            legend.outside = TRUE,
            legend.outside.position = "right",
            legend.outside.size = 0.2,
            legend.width = 12,
            legend.title.size = 0.7,
            legend.text.size = 0.6)

tmap_save(plot_Savail_15m_1, filename ="figures/TEST.png", dpi=600)
```


```{r calculating spatial availability part two, include=FALSE}
Savail_BYMODE_30 <- ttm_ALL_30 |>
  mutate(catch = 1) |>
  sp_avail_detailed(o_id = from_id, #the DA centroid
                    d_id = to_id, #the care destination point
                    pop = Population, #the population of the DA using that mode
                    opp = f,
                    r = catch,
                    f = f,
                    alpha = 1) |>
  group_by(from_id) |>
  group_by(from_id, mode) |> summarize(V_im = sum(V_ij, na.rm = TRUE))

Savail_BYMODE_30$V_im |> sum(na.rm = TRUE) #sums to 2225 opportunities

#now 15 mins
Savail_BYMODE_15 <- ttm_ALL_15 |>
  mutate(catch = 1) |>
  sp_avail_detailed(o_id = from_id, d_id = to_id, pop = Population, opp = f, r = catch, f = f, alpha = 1)|>
  group_by(from_id, mode) |> summarize(V_im = sum(V_ij, na.rm = TRUE))

Savail_BYMODE_15$V_im |> sum(na.rm = TRUE) #sums to 2225 opportunities
```

```{r calculating spatial availability part three, include=FALSE}
#attaching the cum opps to sf object for mapping. First the 30 mins.
HAM_access_30 <- HAM_access_30 |> 
  merge(Savail_BYMODE_30, by.x = c("GeoUID", "mode"),by.y = c("from_id", "mode"), all.x=TRUE) |>
  mutate(V_im = ifelse(is.na(V_im), 0, V_im),
         v_im = case_when(mode == "a_car" ~ V_im/(Population*perc_car),
                                  mode == "c_bike" ~ V_im/(Population*perc_cycle_other),
                                  mode == "d_walk" ~ V_im/(Population*perc_walked),
                                  mode == "b_transit" ~ V_im/(Population*perc_transit)),
         v_im = ifelse(is.nan(v_im) | is.na(v_im), 0, v_im))

# the 15 mins
HAM_access_15 <- HAM_access_15 |> 
  merge(Savail_BYMODE_15, by.x = c("GeoUID", "mode"),by.y = c("from_id", "mode"), all.x=TRUE) |>
  mutate(V_im = ifelse(is.na(V_im), 0, V_im),
         v_im = case_when(mode == "a_car" ~ V_im/(Population*perc_car),
                                  mode == "c_bike" ~ V_im/(Population*perc_cycle_other),
                                  mode == "d_walk" ~ V_im/(Population*perc_walked),
                                  mode == "b_transit" ~ V_im/(Population*perc_transit)),
         v_im = ifelse(is.nan(v_im)| is.na(v_im), 0, v_im))

HAM_access_30$V_im |> sum(na.rm=TRUE) #sums to 2225 opportunities
HAM_access_15$V_im |> sum(na.rm=TRUE) #sums to 2225 opportunities
```

```{r calculating spatial availability part four, include=FALSE}
#creating spatial availability objects that sum up all modes and are just 1 row 1 GeoUID
HAM_access_30_ALLMODE_Savail <- HAM_access_30 |> 
  group_by(GeoUID) |>
  summarize(V_i = sum(V_im)) 

# the 15 mins
HAM_access_15_ALLMODE_Savail <- HAM_access_15 |> 
  group_by(GeoUID) |>
  summarize(V_i = sum(V_im)) 

HAM_access_30_ALLMODE_Savail$V_i |> sum(na.rm=TRUE) #sums to 2225 opportunities
HAM_access_15_ALLMODE_Savail$V_i |> sum(na.rm=TRUE) #sums to 2225 opportunities
```


```{r ploting access plots 1, eval=FALSE}
plot_cum_opp_30m <- 
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_access_30) +
  tm_polygons("cum_opps",
              palette = "Purples",
              breaks = c(0, 66, 246, 753, 2215),
              labels = c("Q1: 0 to 66", "Q2: 66 to 246", "Q3: 246 to 753", "Q4: 753 to 2215"),
              border.alpha = 0,
              title = expression(S[i]^m)) +
  tm_facets(by=c("mode"), nrow=1, showNA = FALSE)+
  tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
  tm_layout(main.title = "Spatially accessible within 30 mins",
            main.title.size = 0.8,
            panel.show = FALSE,
            panel.labels=c("Car","Transit","Bike","Walk"),
            bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            legend.outside = TRUE,
            legend.outside.position = "right",
            legend.outside.size = 0.2,
            legend.width = 12,
            legend.title.size = 0.7,
            legend.text.size = 0.6)

plot_Savail_30m <-
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_access_30) +
  tm_polygons("V_im",
              palette = "Purples",
              breaks = c(0, 0.0000001, 0.005127, 0.328531, 28.361309),
              labels = c("Q1: 0", "Q2: 0 to 0.005", "Q3: 0.005 to 0.33", "Q4: 0.33 to 28.36"),
              border.alpha = 0,
              title = expression(V[i]^m)) +
  tm_facets(by=c("mode"), nrow=1, showNA = FALSE)+
  tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
  tm_layout(main.title = "Spatially available to mode-using population within 30 mins",
            main.title.size = 0.8,
            panel.show = FALSE,
            panel.labels=c("Car","Transit","Bike","Walk"),
            bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            legend.outside = TRUE,
            legend.outside.position = "right",
            legend.outside.size = 0.2,
            legend.width = 12,
            legend.title.size = 0.7,
            legend.text.size = 0.6) 


plot_cum_opp_15m <- 
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_access_15) +
  tm_polygons("cum_opps",
              palette = "Greens",
              breaks = c(0, 12, 47, 242, 1818),
              labels = c("Q1: 0 to 12", "Q2: 12 to 47", "Q3: 47 to 242", "Q4: 242 to 1818"),
              border.alpha = 0,
              title = expression(S[i]^m)) +
  tm_facets(by=c("mode"), nrow=1, showNA = FALSE)+
  tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
  tm_layout(main.title = "Spatially accessible within 15 mins",
            main.title.size = 0.8,
            panel.show = FALSE,
            panel.labels=c("Car","Transit","Bike","Walk"),
            bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            legend.outside = TRUE,
            legend.outside.position = "right",
            legend.outside.size = 0.2,
            legend.width = 12,
            legend.title.size = 0.7,
            legend.text.size = 0.6)

plot_Savail_15m <-
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_access_15) +
  tm_polygons("V_im",
              palette = "Greens",
              breaks = c(0, 0.000000001, 0.001773, 0.129820, 14.142600),
              labels = c("Q1: 0", "Q2: 0 to 0.002", "Q3: 0.002 to 0.13", "Q4: 0.13 to 14.14"),
              border.alpha = 0,
              title = expression(V[i]^m)) +
  tm_facets(by=c("mode"), nrow=1, showNA = FALSE)+
  tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
  tm_layout(main.title = "Spatially available to mode-using population within 15 mins",
            main.title.size = 0.8,
            panel.show = FALSE,
            panel.labels=c("Car","Transit","Bike","Walk"),
            bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            legend.outside = TRUE,
            legend.outside.position = "right",
            legend.outside.size = 0.2,
            legend.width = 12,
            legend.title.size = 0.7,
            legend.text.size = 0.6)
```

```{r saving access plots, eval=FALSE}
plot_copp_Savail_measures <- tmap_arrange(plot_cum_opp_15m, plot_Savail_15m, 
                                          plot_cum_opp_30m, plot_Savail_30m, 
                                          nrow = 4) #width/height
                                          # ,
                                          # asp=1/1.5)

#plot_copp_Savail_measures

tmap_save(plot_copp_Savail_measures, filename ="figures/Fig5-plot_copp_Savail_measures.png", dpi=600) #manually edited - to add mode text ontop of plots
```


```{r plotting categories-walk-15min for cumulative opps, eval=FALSE}
#curious how this distribution could look like
plot_copp_15m_cats_walk <-
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_access_15_cats |> filter(mode =="a_car")) +
  tm_polygons("cum_opps",
              palette = "Greens",
              style = "quantile",
              #breaks = c(0,0.0000000001, 0.000000001, 0.0000345, 0.0009846, 0.0089849),
              #labels = c("0","Q1: 0", "Q2: 0 to <0.00004", "Q3: 0.00004 to <0.00098", "Q4: 0.00098 to 0.0090"),
              border.alpha = 0,
              title = "Destinations spatially accessibility within 15 mins.",
              legend.is.portrait = FALSE) +
  tm_facets(by=c("Care_Category"), nrow=1, showNA = FALSE)+
  tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
  tm_scale_bar(position = c("left", "bottom"), breaks = c(0, 1, 5, 10, 20)) +
  tm_compass(position = c("right", "top"), size=1.0)+
  tm_layout(#panel.labels=c("Car","Transit","Bike","Walk"),
            bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            legend.outside = TRUE,
            legend.position = c("center", "bottom"),
            legend.outside.position = "bottom",
            legend.outside.size = 0.2,
            legend.width = 12,
            legend.title.size = 0.7,
            legend.text.size = 0.6)
```

```{r plotting spatial availability part 2, eval=FALSE}
#plotting the spatial availability measure results
plot_Savail_smallv_30m <-
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_access_30) +
  tm_polygons("v_im",
              palette = "Purples",
              breaks = c(0, 0.0000000001, 0.000000001, 0.0001288 , 0.0025651 , 0.0046746 ),
              labels = c("0","Q1: 0", "Q2: 0 to 0.0001", "Q3: 0.0001 to 0.0026", "Q4: 0.0026 to 0.0047"),
              border.alpha = 0,
              title = "Spatially available destinations to mode-using population per mode-using-capita within 30 mins.",
              legend.is.portrait = FALSE) +
  tm_facets(by=c("mode"), nrow=1, showNA = FALSE)+
  tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
  tm_scale_bar(position = c("left", "bottom"), breaks = c(0, 1, 5, 10, 20)) +
  tm_compass(position = c("right", "top"), size=1.0)+
  tm_layout(panel.labels=c("Car","Transit","Bike","Walk"),
            bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            legend.outside = TRUE,
            legend.position = c("center", "bottom"),
            legend.outside.position = "bottom",
            legend.outside.size = 0.2,
            legend.width = 12,
            legend.title.size = 0.7,
            legend.text.size = 0.6)
```

```{r plotting spatial availability for 30 min all modes summed together, eval=FALSE}
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_access_30_ALLMODE_Savail) +
  tm_polygons("V_i",
              palette = "Purples",
              breaks = c(0,0.0001,1.699, 2.078, 2.642, 28.817 ),
              labels = c("0","Q1: >0 to <1.7", "Q2: 1.7 to <2.1", "Q3: 2.1 to <2.6", "Q4: 2.6 to 28.8"),
              border.alpha = 0,
              title = "Spatially available destinations to mode-using population within 30 mins.",
              legend.is.portrait = FALSE) +
  tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
  tm_scale_bar(position = c("left", "bottom"), breaks = c(0, 1, 5, 10, 20)) +
  tm_compass(position = c("right", "top"), size=1.0)+
  tm_layout(bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            legend.outside = TRUE,
            legend.position = c("center", "bottom"),
            legend.outside.position = "bottom",
            legend.outside.size = 0.15,
            legend.title.size = 0.7,
            legend.text.size = 0.5)
```
```{r} 
#SEE HOW CUM OPP LOOKS UNDER EQUITY ANALYSIS

# test_30 <- HAM_access_30 |> #LH = low v_im (Q2 or Q1) and high LICO (Q3 or Q4). Areas that are transport poor. HL is "otherwise".. so they can be high LICO but with high access etc. )
#   mutate(LH_HL_car = ifelse(mode == "a_car" & cum_opps <= 281.35   & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", ifelse(mode == "a_car" & cum_opps > 281.35   & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
#          LH_HL_transit = ifelse(mode == "b_transit" & cum_opps <= 281.35  & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", ifelse(mode == "b_transit" & cum_opps > 281.35   & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
#          LH_HL_bike = ifelse(mode == "c_bike" & cum_opps <= 281.35    & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", ifelse(mode == "c_bike" & cum_opps > 281.35   & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
#          LH_HL_walk = ifelse(mode == "d_walk" & cum_opps <= 281.35    & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", ifelse(mode == "d_walk" & cum_opps > 281.35   & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
#          LH_HL = coalesce(LH_HL_car,LH_HL_transit, LH_HL_bike, LH_HL_walk),
#          LH_HL = ifelse(is.na(LH_HL), "Else", LH_HL)) |>
#   select(-c(LH_HL_car,LH_HL_transit,LH_HL_bike,LH_HL_walk))
# 
# test_15 <- HAM_access_15 |> #LH = low v_im (Q2 or Q1) and high LICO (Q3 or Q4). Areas that are transport poor. HL is "otherwise".. so they can be high LICO but with high access etc. )
#   mutate(LH_HL_car = ifelse(mode == "a_car" & cum_opps<= 51.79   & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", ifelse(mode == "a_car" & cum_opps> 51.79   & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
#          LH_HL_transit = ifelse(mode == "b_transit" & cum_opps<= 51.79    & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", ifelse(mode == "b_transit" & cum_opps> 51.79   & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
#          LH_HL_bike = ifelse(mode == "c_bike" & cum_opps<= 51.79    & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", ifelse(mode == "c_bike" & cum_opps> 51.79   & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
#          LH_HL_walk = ifelse(mode == "d_walk" & cum_opps<= 51.79    & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", ifelse(mode == "d_walk" & cum_opps> 51.79   & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
#          LH_HL = coalesce(LH_HL_car,LH_HL_transit, LH_HL_bike, LH_HL_walk),
#          LH_HL = ifelse(is.na(LH_HL), "Else", LH_HL)) |>
#   select(-c(LH_HL_car,LH_HL_transit,LH_HL_bike,LH_HL_walk))
#   
# plot_Savail_smallv_LICO_30m <-
#   tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
#   tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
#   tm_shape(test_30) +
#   tm_polygons("LH_HL",
#               palette = c("palegreen","grey", "red"),
#               labels = c("High-V & no-LICO", "Else", "Low-V & high-LICO"),
#               border.alpha = 0,
#               #legend.is.portrait = FALSE,
#               title = "") +
#   tm_facets(by=c("mode"), nrow=1, showNA = FALSE)+
#   tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
#   tm_scale_bar(position = c("left", "bottom"), breaks = c(0, 1, 5, 10, 20)) +
#   tm_compass(position = c("right", "top"), size=1.0)+
#   tm_layout(panel.labels=c("Car","Transit","Bike","Walk"),
#             bg.color = "grey",
#             panel.label.bg.color = "white",
#             panel.label.color = "black",
#             # legend.outside = TRUE,
#             # legend.position = c("center", "bottom"),
#             # legend.outside.position = "bottom",
#             main.title = "Within 30 minute travel time",
#             main.title.position = c("left","top"),
#             main.title.size = 1,
#             legend.show = FALSE)
# 
# plot_Savail_smallv_LICO_15m <-
#   tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
#   tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
#   tm_shape(test_15) +
#   tm_polygons("LH_HL",
#               palette = c("palegreen","grey", "red"),
#               labels = c("High-V & no-LICO", "Else", "Low-V & high-LICO"),
#               border.alpha = 0,
#               legend.is.portrait = FALSE,
#               title = "") +
#   tm_facets(by=c("mode"), nrow=1, showNA = FALSE)+
#   tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
#   tm_scale_bar(position = c("left", "bottom"), breaks = c(0, 1, 5, 10, 20)) +
#   tm_compass(position = c("right", "top"), size=1.0)+
#   tm_layout(panel.labels=c("Car","Transit","Bike","Walk"),
#             bg.color = "grey",
#             panel.label.bg.color = "white",
#             panel.label.color = "black",
#             main.title = "Within 15 minute travel time",
#             main.title.position = c("left","top"),
#             main.title.size = 1,
#             legend.show = FALSE)
# 
# plot_Savail_smallv_LICO_15_30_LEGEND <- tm_shape(HAM_access_15) + 
#   tm_polygons("LH_HL",
#               palette = c("palegreen","grey", "red"),
#               labels = c("High-V & no-LICO", "Else", "Low-V & high-LICO"),
#               border.alpha = 0,
#               legend.is.portrait = FALSE,
#               title = "") + 
#   tm_layout(legend.only = T, legend.position = c("center", "top"))
# 
# plot_Savail_smallv_LICO_measures <- tmap_arrange(
#   plot_Savail_smallv_LICO_15m, 
#   plot_Savail_smallv_LICO_30m, 
#   plot_Savail_smallv_LICO_15_30_LEGEND,
#   asp=1/1.5)
# plot_Savail_smallv_LICO_measures
```

```{r calculation for plotting of spatial availability per pop low and poor vs high and not-poor}
#equity considerations
HAM_access_30 <- HAM_access_30 |> #LH = low v_im (Median and below) and high LICO (Q3). Areas that are transport poor. HL is "otherwise".. so they can be high LICO but with high access etc. )
  mutate(LH_HL_car = ifelse(mode == "a_car" & v_im <= 0.0001288  & LICO_AT_TOTAL >= 8.400, "Lacc-HLICO", 
                            ifelse(mode == "a_car" & v_im > 0.0001288  & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
         
         LH_HL_transit = ifelse(mode == "b_transit" & v_im<= 0.0001288   & LICO_AT_TOTAL>=8.400, "Lacc-HLICO",
                                ifelse(mode == "b_transit" & v_im> 0.0001288  & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
         
         LH_HL_bike = ifelse(mode == "c_bike" & v_im<= 0.0001288   & LICO_AT_TOTAL>=8.400, "Lacc-HLICO",
                             ifelse(mode == "c_bike" & v_im> 0.0001288  & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
         
         LH_HL_walk = ifelse(mode == "d_walk" & v_im<= 0.0001288   & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", 
                             ifelse(mode == "d_walk" & v_im> 0.0001288  & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
         
         LH_HL = coalesce(LH_HL_car,LH_HL_transit, LH_HL_bike, LH_HL_walk),
         LH_HL = ifelse(is.na(LH_HL), "Else", LH_HL)) |>
  select(-c(LH_HL_car,LH_HL_transit,LH_HL_bike,LH_HL_walk))

HAM_access_15 <- HAM_access_15 |> #LH = low v_im (median or below) and high LICO (Q3 or Q4). Areas that are transport poor. HL is "otherwise".. so they can be high LICO but with high access etc. )
  mutate(LH_HL_car = ifelse(mode == "a_car" & v_im<= 0.0000438  & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", 
                            ifelse(mode == "a_car" & v_im> 0.0000438  & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
         
         LH_HL_transit = ifelse(mode == "b_transit" & v_im<= 0.0000438   & LICO_AT_TOTAL>=8.400, "Lacc-HLICO", 
                                ifelse(mode == "b_transit" & v_im> 0.0000438  & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
         
         LH_HL_bike = ifelse(mode == "c_bike" & v_im<= 0.0000438   & LICO_AT_TOTAL>=8.400, "Lacc-HLICO",
                             ifelse(mode == "c_bike" & v_im> 0.0000438  & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
         
         LH_HL_walk = ifelse(mode == "d_walk" & v_im<= 0.0000438   & LICO_AT_TOTAL>=8.400, "Lacc-HLICO",
                             ifelse(mode == "d_walk" & v_im> 0.0000438  & LICO_AT_TOTAL==0, "Hacc-NOLICO",NA)),
         
         LH_HL = coalesce(LH_HL_car,LH_HL_transit, LH_HL_bike, LH_HL_walk),
         LH_HL = ifelse(is.na(LH_HL), "Else", LH_HL)) |>
  select(-c(LH_HL_car,LH_HL_transit,LH_HL_bike,LH_HL_walk))
```


```{r plotting spatial availability per pop low and poor vs high and not-poor, eval=FALSE}
plot_Savail_smallv_LICO_30m <-
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_access_30) +
  tm_polygons("LH_HL",
              palette = c("springgreen4","grey", "yellow"),
              labels = c("High v & no or low LICO", "Else", "Low or no v & high LICO"),
              border.alpha = 0,
              #legend.is.portrait = FALSE,
              title = "") +
  tm_facets(by=c("mode"), nrow=1, showNA = FALSE)+
  tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
  tm_scale_bar(position = c("left", "bottom"), breaks = c(0, 1, 5, 10, 20)) +
  tm_compass(position = c("right", "top"), size=0.5)+
  tm_layout(panel.labels=c("Car","Transit","Bike","Walk"),
            bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            # legend.outside = TRUE,
            # legend.position = c("center", "bottom"),
            # legend.outside.position = "bottom",
            main.title = "Within 30 minute travel time",
            main.title.position = c("left","top"),
            main.title.size = 0.9,
            legend.show = FALSE)

plot_Savail_smallv_LICO_15m <-
  tm_shape(ham_bay, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=hamilton_communities) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(HAM_access_15) +
  tm_polygons("LH_HL",
              palette = c("springgreen4","grey", "yellow"),
              labels = c("High v & no or low LICO", "Else", "Low or no v & high LICO"),
              border.alpha = 0,
              legend.is.portrait = FALSE,
              title = "") +
  tm_facets(by=c("mode"), nrow=1, showNA = FALSE)+
  tm_shape(hamilton_communities) + tm_polygons(alpha=0)+
  tm_scale_bar(position = c("left", "bottom"), breaks = c(0, 1, 5, 10, 20)) +
  tm_compass(position = c("right", "top"), size=0.5)+
  tm_layout(panel.labels=c("Car","Transit","Bike","Walk"),
            bg.color = "grey",
            panel.label.bg.color = "white",
            panel.label.color = "black",
            main.title = "Within 15 minute travel time",
            main.title.position = c("left","top"),
            main.title.size = 0.9,
            legend.show = FALSE)

plot_Savail_smallv_LICO_15_30_LEGEND <- tm_shape(HAM_access_15) + 
  tm_polygons("LH_HL",
              palette = c("springgreen4","grey", "yellow"),
              labels = c("High v & no or low LICO", "Else", "Low or no v & high LICO"),
              border.alpha = 0,
              legend.is.portrait = FALSE,
              title = "") + 
  tm_layout(legend.only = T, legend.position = c("center", "top"))

plot_Savail_smallv_LICO_measures <- tmap_arrange(
  plot_Savail_smallv_LICO_15m, 
  plot_Savail_smallv_LICO_30m, 
  plot_Savail_smallv_LICO_15_30_LEGEND,
  asp=1/1.5)
plot_Savail_smallv_LICO_measures
tmap_save(plot_Savail_smallv_LICO_measures, filename ="figures/Fig6-plot_Savail_smallv_LICO_measures.png", dpi=600) #I manually crop out the white space at the bottom using MS Paint.
```

# Introduction
A gender bias exists in transport research and policy [@sanchezdemadariagaMobilityCareIntroducing2013; @lawWomenTransportNew1999; @siemiatyckiGenderedProductionInfrastructure2020]. The field has focused predominately on the on-peak commute to work. While most women participate in the labour force, the commute is still a travel pattern more frequent among men [@sanchezdemadariagaMobilityCareIntroducing2013]. Women, on the other hand, have been found to complete more household-serving travel than men, such as escorting children [@craigGenderMobilityParental2019; @taylorWhatExplainsGender2015; @hanTaskAllocationGender2019; @mcdonaldExploratoryAnalysisChildren2006], shopping, and errand trips [@taylorWhatExplainsGender2015;@rootWomenTravelIdea2000; @sweetGenderDifferencesRole2016]. 

Although research on the gendered distribution of household-serving travel has existed for decades, it was SÃ¡nchez de Madariaga who introduced the "Mobility of Care" framework to support the proper accounting of travel needed to fulfill caring and home-related activities (e.g., the combined travel to grocery stores, errands, and picking-up or dropping off children) [@sanchezdemadariagaMobilityCareIntroducing2013]. Mobility of Care highlights how household-serving travel is systematically under-represented, under-counted, and rendered invisible in transport planning, particularly in travel surveys. Travel surveys are a key source of mobility data for transportation planners in metropolitan cities, and their focus is often on the collection of 'compulsory' trip purposes such as school and work. In the Canadian context, respondents of the Transportation Tomorrow Survey (TTS) which encompasses the cities of Toronto, Hamilton and surrounding urban area [@transportationtomorrowsurvey2018], are given the following options to categorize their trip origins and destinations: home, work, school, daycare, facilitate passenger, marketing/shopping, other, or unknown. While home-work and home-school trips are easily identified, care trips are more challenging to discern. Likely, many shopping trips are for care purposes (e.g., groceries), but others may be for leisure. While escort trips may be well captured under the categories âdaycareâ or âfacilitate passengerâ, trips to run errands or to attend health appointments may not be; it is probable that respondents categorize many of these trips as âotherâ or even âunknownâ. Ultimately, the travel survey's focus is on a 'typical' trip to work or school [@transportationtomorrowsurvey2018]; other trips are a by-product, minimized in importance. Of course, people's travel behaviours are complex and surveys must balance detail with summary. However, what is seen as a 'typical' trip continues to shape transport and land-use, and this aggregation helps to steer data-driven solutions using the counted and observed home -work/-school based trips.

When travel surveys _are_ designed to explicitly capture mobility of care, preliminary research has found that it comprises approximately one third of adultsâ trips [@gomezvaroAccountingCareEveryday2023; @sanchezdemadariagaMobilityCareIntroducing2013;@sanchezdemadariagaMeasuringMobilitiesCare2019; @ravensbergenExploratoryAnalysisMobility2022]. Given the large proportion of daily travel that mobility of care comprises, these trips should be explicitly captured in transport research. Further, the current under-reporting of mobility of care in research and planning has important equity considerations. Not only are mobility of care trips completed predominantly by women, this gendered discrepancy is greater in low-income households [@murillomunarCaregiversMoveGender2023; @sanchezdemadariagaMobilityCareIntroducing2013; @ravensbergenExploratoryAnalysisMobility2022]. For instance, in lower income households in the city of MontrÃ©al, women complete 50% more care trips than men [@ravensbergenExploratoryAnalysisMobility2022]. The power of the Mobility of Care concept lies in its ability to highlight the masculinist bias in transport research â travel for care appears insignificant because travel surveys are not written to capture it [@sanchezdemadariagaMobilityCareIntroducing2013].

Travel surveys, however, are but one source of information used by transport researchers and practitioners. Another popular instrument is accessibility, especially in the case of sustainable and equitable cities [@ryanAccessibilitySpaceTime2023; @bertoliniSustainableAccessibilityConceptual2005]. Accessibility is an indicator that quantifies the ease of reaching, and potentially interacting with, destinations. The point of interest in many accessibility-based assessments has been on travel to work destinations by car or public transit modes e.g., [@kelobonyeRelativeAccessibilityAnalysis2019; @farberOntarioLineSocioeconomic2019; @duarteInfluenceJobAccessibility2023; @ryanAccessibilitySpaceTime2023;@soukhovMultimodalSpatialAvailability2024]. However, jobs are not always the most significant destination for many segments of the population. Further, modal options to employment and care differ. For example, women's commutes are on average a smaller proportion of their daily travel than men's [@ravensbergenExploratoryAnalysisMobility2022]. Care trips are also less likely to be completed by public transit or bicycle, and are more likely by car or by foot than the commute [@ravensbergenExploratoryAnalysisMobility2022]. One way to apply a gender-sensitive lens to accessibility analysis is by explicitly considering access to destinations involved in Mobility of Care by multiple modes. Normatively reframing accessibility analysis in this way explicitly reinforces its importance as a supportive tool in the planning of sustainable and equitable cities. 

Taken together, this study's objective is to contribute to the transport planning literature through the demonstration of a multimodal accessibility analysis of Mobility of Care destinations. Two accessibility measures are used: the cumulative opportunity measure and the singly-constrained spatial availability measure. The measures are applied to a care destination dataset with novel Mobility of Care classifications for the city of Hamilton, Canada. The access to care destinations by car, walking, cycling and transit is calculated for 15- and 30-minute travel time thresholds. Results are compared across the two measures and four modes, and the overlap between low accessibility areas and high low-income prevalence is presented. Implications of the results are discussed along with study conclusions.

# Overview of multimodal accessibility analysis

As indicators of "the potential of opportunities for interaction" [@hansenHowAccessibilityShapes1959], accessibility measures can also be interpreted as the relative ease of reaching destinations using transport networks. They are a byproduct of mobility and are a representation of the people's interaction with land-use and transportation systems [@hansenHowAccessibilityShapes1959; @handyAccessibilityIdeaWhose2020; @elgeneidyMakingAccessibilityWork2021]. 

The cumulative opportunity measure is a popular accessibility measure, widely appreciated for its intuitive computation [@handyAccessibilityIdeaWhose2020; @handyMeasuringAccessibilityExploration1997; @kelobonyeRelativeAccessibilityAnalysis2019; @chengInvestigatingWalkingAccessibility2019]. It quantifies how many destinations can be reached from a point in space within a given travel time threshold. The measure has been used to quantify access, given a travel time threshold and mode, often to employment destinations. For instance, @kapatsilaResolvingAccessibilityDilemma2023, @deboosereEvaluatingEquityAccessibility2018a and @tomasiello2023time explore access to employment by car and/or transit, @faghihimaniCycleAccessibilityLevel2019 calculates employment access by bike, and @singhCumulativeOpportunitybasedAccessibility2022 measures access to employment by foot. However, non-work amenities have also been analysed by this popular measure as well. For example, @hosford15minuteCityReach2022 investigates grocery store access, and the works of @mccahillNonworkAccessibilityRelated2018, @klumpenhouwerFlexibleFrameworkMeasuring2021 and @chengInvestigatingWalkingAccessibility2019 investigate 'baskets' of urban-amenities. The cumulative opportunity accessibility literature has yet to focus its analysis on destinations selected from the perspective of Mobility of Care. 

A critique leveled at cumulative opportunity measures (and other non-competitive accessibility measures) is its omission of competition-for-opportunities effects [@soukhovIntroducingSpatialAvailability2023; @kelobonyeMeasuringAccessibilitySpatial2020; @merlinDoesCompetitionMatter2017]. Conceptually, this consideration is important as opportunities are finite, so there is bound to be competition between the population seeking them. However, planners often opt for simpler measures [@kapatsilaResolvingAccessibilityDilemma2023], as measures that account for competition tend to be more difficult to implement and interpret [@merlinDoesCompetitionMatter2017]. In the recent work of @soukhovIntroducingSpatialAvailability2023, an accessibility measure named Spatial Availability is introduced that simplifies the interpretation of resulting values while considering competition using population and travel cost proportional allocation balancing factors. Spatial availability was then extended for multimodal applications in @soukhovMultimodalSpatialAvailability2024. Notably, the use of competitive accessibility measures to explore access to a variety of destinations is relatively scarce, with some recent exceptions [e.g., @kelobonyeMeasuringAccessibilitySpatial2020; @singhCumulativeOpportunitybasedAccessibility2022]. Moreover, competitive accessibility measures have not yet been focused on Mobility of Care.

As such, in this work, two multimodal accessibility measures are implemented for the calculation of accessibility to Mobility of Care destinations. The first is the cumulative opportunity measure, and the second is a competitive and singly-constrained measure, spatial availability [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024].

# Background on Hamilton

This paper focuses on Hamilton as a case study, a mid-size city of approximately 500,000 residents that lies within the urban and suburban Greater Toronto and Hamilton Area (GTHA) [@transportationtomorrowsurvey2018]. The GTHA is home to seven million people, or approximately 20% of the Canadian population [@cityoftoronto2021CensusPopulationa2022]. 

Hamilton is divided into six regional communities (@fig-Fig1). Hamilton-Central is the most urbanized of the six, and the five periphery communities of Dundas, Ancaster, Flamborough, Glanbrook and Stoney Creek are significantly more suburban, with the furthest periphery regions being undeveloped or rural owing to their inclusion in the regionâs greenbelt [@greenbeltfoundationThrivingGreenbeltThriving2023]. These different urban forms and associated transport infrastructure play a key role in access to care destinations. Hamilton Street Railway (HSR) is the city's transit provider, and at the current date only operating buses. Notably, Hamilton-Central is the only community fully serviced by HSR and has the highest concentration of walking and bike infrastructure for mainstream use (e.g., Level of Traffic Stress 1 or 2 which indicates low-speed, low-volume streets, separated bicycle facilities, and dedicated lanes where cyclist must interact with traffic at formal crossings) [@conveyalCyclingLevelTraffic2024] as identified in the OpenStreetMaps road network [@geofabrikOntarioCanadaOpen2023] and the city's General Transit Feed Specification file [@transitfeedsHamiltonStreetRailway2023]. 


```{r plot-figure1, out.width=600}
#| label: fig-Fig1
#| fig-cap: "The six former muncipal boundaries in the city of Hamilton (green), highways and arerial roads (grey), walking and cycling infrastructure (light grey), and concentration of transit bus stops (reds). Geographic layer sources: road network [@geofabrikOntarioCanadaOpen2023], transit stops [@transitfeedsHamiltonStreetRailway2023], community boundaries [@opendatahamiltonCityBoundary2023] and lake [@greatlakesUSGS2010]."
knitr::include_graphics("figures/Fig1-descriptive-boundaries.png") 
```

## Care destination dataset

A spatial dataset of care destinations for Hamilton was compiled from various sources, and destination operation was manually verified using Google Maps. To showcase the dataset, each type of destination is grouped into one of five care destination categories. These five categories were generated by the authors following the travel purpose categories created in the mobility of care research by @sanchezdemadariagaMeasuringMobilitiesCare2019. Notably: child-centric (destinations for "childcare" escorting trips), elder-centric (common destinations for other escorting trips that are not childcare-focused), grocery-centric, health-centric, and errand-centric destinations. The majority of destinations included can be publicly accessed (e.g., only public schools, grocery stores, clinics, community centres). However, certain destinations may require a fee that could be prohibitive for lower-income households (e.g., all long term care homes, both publicly subsided or private are included in the dataset). Category sources of data and preparation notes are detailed in @tbl-Tbl1. Their spatial distribution and sub-categories are visualised in @fig-Fig2.

```{r creating-table-content}
dat <- data.frame(matrix(c("Child-centric",
                           "[@opendatahamiltonEducationalInstitutions2022; @governmentofontarioOntarioDataCatalogue2023; @cityofhamiltonChildCareRegistry2023; @opendatahamiltonParksDatabase2022; @opendatahamiltonRecreationCommunityCentres2022]",
                           "Public schools, public and private (licensed) daycares, and public community centres, public recreation centres, and public parks: 1,190 locations are included. After manual review, all locations that typically do not serve children were removed including: Post-Secondary, Adult-Learning Centres, Group Homes, and Foster Care Centres. Further, through examination some Section 23 institutions defined as _âcentres for children who cannot attend school to meet the needs of care or treatment, and rehabilitationâ_ [@governmentofontarioministryofeducationFundingEducationCommunity2023], were kept due to their innate connection to care.",
                           "Elder-centric",
                           "[@opendatahamiltonRecreationCommunityCentres2022; @ontarioministryofhealthgeohubMinistryHealthService2023]",
                           "Public and private senior centres, long-term care homes, and retirement homes: 75 destinations are identified.",
                           "Grocery-centric",
                           "[@axledataConsumerData2023]",
                           "Grocery stores, namely a place a household could buy groceries ranging from convenience stores to large retail stores: 381 destinations are identified. Data is filtered by Company Name, Suite Number, Address, City, Province, Phone Number and Postal Code. The type was then identified e.g., grocers specialty foods, grocers retail, grocer health food, grocer wholesale, grocer curbside, grocer delicatessen wholesale, grocer convenience. Data was crossreferenced to ensure all included locations were operational and legitimate grocery stores.",
                           "Health-centric",
                           "[@ontarioministryofhealthgeohubMinistryHealthService2023; @hamiltonniagarahaldimandbranthealthlineWalkInMedicalClinics2023]",
                           "Hospitals, pharmacies, clinics, and dentist offices: 421 destinations are identified. Hospitals and pharmacies were retrieved while clinics and dentistry clincs were manually scraped from a healthcare services database and checked via Google Maps to remove non-operational locations and confirm dentistry-orientation. ",
                           "Errand-centric",
                           "Hamilton libraries [@opendatahamiltonLibraries2022], post office locations [@axledataConsumerData2023;@canadapostPostOfficeLocator2023], and datasets of all national bank chains [@bankofmontrealBankMontrealBranch2023; @thehongkongandshanghaibankingcorporationlimitedhsbcHSBCBranchABM2023; @nationalbankNationalBankBranches2023; @royalbankofcanadaRBCBranchABM2023; @scotiabankScotiabankABMBranch2023; @thetorontodominionbankTDBankBranch2023].",
                                                      "Libraries, post offices, and banks: 158 destinations are identified. Post offices are retrieved from a mix of databases, and duplicates are removed. Banks are also derived from Data Axle and then cross-referenced to ensure data quality with a Bank Locator website for all national banking firms."
                           ), ncol = 3, byrow = T))
```

```{r creating-table}
#| tbl-cap: "Details on the preparation and data sources of care destinations."
#| label: tbl-Tbl1
set_flextable_defaults(font.size= 8,
                       font.family = NULL,
                       text.align = 'justify',
                       table.layout = 'fixed')

flextable(dat) %>%
  ftExtra::colformat_md() %>%
  compose(
    i = 1, j = c(1,2,3), part = "header", value = as_paragraph(c("Care category", "Sources", "Data preparation notes"))) %>%
  width(j = 1, width = 1.7, unit = "cm") %>%
  width(j = 2, width = 4.3, unit = "cm") %>%
  width(j = 3, width = 11, unit = "cm")
```

```{r plot-figure2, out.width=600}
#| label: fig-Fig2
#| fig-cap: "Locations of care destinations in the City of Hamilton tagged by the author-generated categories of: child-, elder-, errand-, grocery- and health- centric care categories. Locations of these destinations were retrieved through multiple sources as described. Basemap shapefiles are sourced from the Open Data Hamilton Portal [@opendatahamiltonCityBoundary2023] and the USGS [@greatlakesUSGS2010]."
knitr::include_graphics("figures/Fig2-plot_care_categories.png")
```

## Population data
To supplement the care destination dataset and complete the accessibility calculation (discussed in Methods Section 4), population data for the City of Hamilton is sourced from the 2021 Canadian census using the {cancensus} R Package [@governmentofcanadaCensusPopulation2023; @vonbergmannCancensusCensusMapper2021]. Three categories of variables are selected: the population, the percent of after-tax low-income-cut-off (LICO), and the primary commute mode used. LICO is a composite indicator that reflects the proportion of households spending 20% more than the area average on food, shelter and clothing [@governmentofcanadaLowIncomeCutoffs2023]. As stated in the Introduction Section 1, women, especially those in low-income households, preform the majority of care trips. However, since the proportion of women and men residing across the city is balanced, this study focuses on the total population and total LICO prevalence. All data was sourced at the most granual level of spatial resolution publicly available, the level of the dissemination area (DA). 

@fig-Fig3 displays the spatial distribution of the total population and LICO as a percentage of the total population. Notably, the density of population within Hamilton-Central (oranges) and the cluster of high density and high LICO prevalence near the shoreline in Hamilton-Central (dark purple-oranges).

```{r plot-figure3, out.width=600}
#| label: fig-Fig3
#| fig-cap: "The total population in each dissemination area (DA), visualized with the six former muncipal boundaries in the city of Hamilton. The left plot represents the population (legend represents quartiles) and the right represents population density versus the low-income cut-off after taxes (LICO) as a percentage of the total DA population. Basemap shapefiles are retrieved from the 2021 Canadian census [@governmentofcanadaCensusPopulation2023], the Open Data Hamilton Portal [@opendatahamiltonCityBoundary2023] and the USGS [@greatlakesUSGS2010]."
knitr::include_graphics("figures/Fig3-plot_pops.png")
```

Further, the population proportion that commutes by a specific mode (car, transit, walk, or cycle/other) is visualised in @fig-Fig4. Though mode choice used in travel to work is not necessarily reflective of the mode used to travel to care destinations, no other data is available at a granular level City-wide that captures mobility of care travel to our knowledge. The population generally commutes by car (50% or higher, is yellow to green), even within the more densely populated Hamilton-Central. However, for transit and walking, a grouping of DAs near the shoreline within Hamilton-Central have the highest proportion of transit users and those who walk to work (yellows in the plots that are otherwise red i.e., below 15%). Those same DAs are also relatively dense and have a high prevalence of LICO.

```{r plot-figure4, out.width=600}
#| label: fig-Fig4
#| fig-cap: "The proportion of mode type used for commuting (aged 15 and older employed in the labour force) in each dissemination area (DA) as provided by the 2021 Canadian census. Basemap shapefiles are retrieved from the 2021 Canadian census [@governmentofcanadaCensusPopulation2023], the Open Data Hamilton Portal [@opendatahamiltonCityBoundary2023] and the USGS [@greatlakesUSGS2010]."
knitr::include_graphics("figures/Fig4-plot_modal_splits.png")
```

## Transportation network and travel time estimations

Travel time to care destinations by walking, cycling, transit and car is approximated using the 'travel_time_matrix()' function from the {r5r} package [@pereiraR5rRapidRealistic2021]. Inputs into the function are locations of DA centroids (origins), care destinations centroids, an OpenStreetMap road network including bike, transit and vehicle infrastructure [@geofabrikOntarioCanadaOpen2023], and city GTFS transit routes/schedules [@transitfeedsHamiltonStreetRailway2023]. For all modes, travel times under 60 minutes based on the shortest travel-time path are calculated. 

For transit and cycling, additional parameters were included. For transit travel times, a Wednesday departure time of 8:00AM was selected [@boisjolyDailyFluctuationsTransit2016] with a departure travel window parameter of 30 mins. Travel times are calculated for each minute of the travel window (8:00-8:30AM) and the 25th percentile from the distribution of travel window times were selected to represent each origin-destination. Selecting a sufficiently wide window is an important consideration as travel times are sensitive to transit vehicle frequency and connecting transfers (see discussion of the modifiable temporal unit problem e.g., [@pereiraFutureAccessibilityImpacts2019]). The 25th percentile indicates that 25% of trips from that origin to destination have a travel time that is that length or shorter. This assumption provides a more optimistic perspective on transit travel times. For cycling travel times, level 1 or 2 level of traffic stress (LTS) routes (i.e., dedicated or separated cycling lanes, respectively) were selected. The LTC is a calculated variable associated with links of the OSM road network. LTS 1 and 2 are considered mainstream cycling conditions [@faghihimaniCycleAccessibilityLevel2019] and are the function's default.

# Accessibility measurement methods

Two accessibility measures are detailed: the cumulative opportunity measure and the spatial availability measure. Both yield a value per spatial unit that represents how many care destinations can be reached within a given travel time, for a given mode. However, both measures have different underlying assumptions; the first does not consider competition effects and the second does. 

## Cumulative opportunities: the number of care opportunities that can be reached by a mode within a travel time

Often referred to as the cumulative opportunity measure, it is a special form of the gravity-based accessibility measure [@handyMeasuringAccessibilityExploration1997]. It receives its name from its interpretation: the value calculated for each spatial unit (DAs in this study) represents the number of opportunities that could be spatially accessed within a given travel time. The cumulative opportunity accessibility measure takes the following general form for a multimodal calculation:
$$
S_i^m=\sum_{j}O_j\cdot f^m(c_{ij}^m)
$${#eq-1}
\noindent Where:

- $i$ is a set of origin locations (e.g., DA centroids)
- $j$ is a set of destination locations (e.g., care destinations)
- $m$ is a set of modes (e.g., by foot, cycle, transit and car)
- $O_j$ is the number of opportunities at $j$ (e.g., in this study, the presence of a care destination)
- $c_{ij}^m$ is the travel cost between $i$ and $j$ for each $m$.
- $f^m(\cdot)$ is an impedance function of $c^m_{ij}$ for each $m$; within the cumulative opportunity measure, it is a binary function that takes the value of 1 if $c^m_{ij}$ is less than a selected value.
- $S^m_{i}$ is the cumulative opportunities accessible by $m$ at each $i$.

## Spatial availability: the number of care opportunities that are spatially available to a mode-user within a travel time

Differing from cumulative opportunity measure, the spatial availability measure considers competition. The spatial availability value for each origin $i$ for a given mode $m$ represents the number of care opportunities that can be accessed by a mode-user out of _all_ care opportunities in Hamilton. Spatial availability considers competition through the proportional allocation of opportunities to a given $i$. The proportional allocation balancing factors are based on the relative proportion of population computing for an opportunity and their travel times to reachable destinations.Â Spatial availability, takes the following general form for multi-modal calculation:
$$
V^m_{i} = \sum_{j} O_j\ F^{tm}_{ij}
$${#eq-2}
\noindent Where: 

- Like in @eq-1, $i$, $j$, and $m$ is a set of origin locations, destination locations, modes respectively and $O_j$ is the number of opportunities at $j$. 
- $V^m_{i}$ is the cumulative opportunities spatially available by $m$-using population at $i$ for each $i$.
- $F^{tm}_{ij}$ is a total balancing factor for each $m$ at each $i$; it considers the size of the populations at different locations that demand opportunities $O_j$, as well as the cost of movement in the system $f(c_{ij})$.

What makes spatial availability stand apart from other competitive measures is the multimodal balancing factor $F^{tm}_{ij}$ [see @soukhovMultimodalSpatialAvailability2024; @soukhovIntroducingSpatialAvailability2023]. $F^{tm}_{ij}$ implements a proportional allocation mechanism that ensures the sum of all spatial availability values at each $i$ always matches the total number of opportunities in the region. In other words, it ensure an opportunity-side (single) opportunities remain constrained such that the sum of $V^m_{i}$ for all $m$ at each $i$ is equivalent to the total sum of opportunities in the region (i.e., $\sum_j O_j = \sum_i V_i = \sum_{m} \sum_{i} V^m_{i}$). This constraint helps in clarifying the interpretation of the $V^m_{i}$ value itself.

The total proportional allocation factor $F^{tm}_{ij}$ consists of two parts: the first is a population-based proportional allocation factor $F_i^{pm}$ that models the mass effect (relative population-demand for opportunities) and the second is an impedance-based proportional allocation factor $F_{ij}^{cm}$ that models the cost effect (relative travel time). Both factors consider competition through proportional allocation: $F^{pm}_{i}$ estimates a proportion of how many people are in each $i$ and using each $m$ relative to the region and $F^{cm}_{ij}$ estimates a proportion of the cost of travel from $i$ to $j$ at each $i$ using each $m$ relative to the region. Both factors are combined to create the total balancing factor $F^{tm}_{ij}$ used to calculate $V^m_i$:

$$
F^{tm}_{ij} = \frac{F^{pm}_{i} \cdot F^{cm}_{ij}}{\sum_{m} \sum_{i} F^{pm}_{i} \cdot F^{cm}_{ij}}
$${#eq-3}
\noindent Where:

- The factor for allocation by population for each $m$ at each $i$ is $F^{pm}_{i} = \frac{P_{i}^m}{\sum_{m}\sum_{i} P_{i}^m}$. This factor makes opportunities available based on demand.
- The factor for allocation by cost of travel for each $m$ at $i$ is $F_{ij}^{cm} = \frac{f^m(c_{ij}^m)}{\sum_{m} \sum_{i} f^m(c_{ij}^m)}$. This factor makes opportunities available preferentially to those who can reach them at a lower cost.


## Travel impedance function

A uniform binary travel impedance function $f^m(c_{ij}^m)$ is assumed; specifically, when $c_{ij}$ is equal or below a certain travel time threshold, $f^m(c_{ij}^m)$ equals 1, otherwise, $f^m(c_{ij}^m)$ equals 0. Two travel time thresholds are selected for both measures: 15 minutes and 30 minutes for all modes. 

This selection is informed by a scan of the literature. Typically, literature considers travel to one type of care category (e.g., health, or school, or grocery stores) and each destination type is associated with varied travel impedance behaviour. As examples, grocery shopping trips are on average 15 in @hamrickTimeCostAccess2012, trips to receive cancer treatments are on average 23.6 minutes for non-white metro residents in @segelRuralurbanDifferencesAssociation2020], travel time thresholds of 10 mins are selected for a daycare analysis in @fransenCommuterbasedTwostepFloating2015, and 30 mins to 1 hr travel time thresholds are selected for hospitals in @schuurmanDefiningRationalHospital2006. 
Travel times also depend on the mode used. From the perspective of mobility of care, average travel times to all different categories of care destinations are on average 16 minutes by car and 36 minutes by public transportation [@ravensbergenExploratoryAnalysisMobility2022]. To broadly reflect this past research: 15 and 30 minutes are selected in this study.

As previously discussed, the use of binary travel impedance functions as opposed to distance decay impedance functions was selected to simplify communication of the assumed travel behaviour. Lacking region-specific empirical data regarding care-centric travel, this work establishes a methodology to streamline access to care interpretation and analysis for when that data is available.

# Results

## Cumulative opportunities: access to care 
The cumulative opportunity and spatial availability plots for each mode and 15-minute and 30-minute travel time thresholds are shown in @fig-Fig5.  Each cumulative opportunities value represents a cumulative count of care opportunities that can be spatially accessed by each mode from each DA, where each opportunity represents a reachable care destination. The spatial availability measure presents a constrained interpretation of this measure; each value is a cumulative count of care opportunities that can be spatially accessed from each DA and _are spatially available to the mode-using population based on the relative size of the mode-using population and modal travel times_.  As proportional allocation is used, each spatial
availability value can also be interpreted as the _spatially available_ proportion of the total care destinations in the city, i.e., the sum of all spatial availability values in the second row of @fig-Fig5 equal, the total number of care destinations in this case study.

In both measures, the higher the value, the more potential interaction with care opportunities. This greater potential of opportunity of interaction is conceptualised as a positive outcomes of well functioning land-use and transport networks [@corderaImpactAccessibilityPublic2019; @blumenbergDriveWorkRelationship2017; @cuiSpatialAccessPublic2020]. In @fig-Fig5, values are grouped by quantile and spatial trends between the 15-min and 30-min threshold plots are highly correlated (`r cor(HAM_access_15$cum_opps,HAM_access_30$cum_opps) |> round(digits=2)` for cumulative opportunities and for `r cor(HAM_access_15$V_im,HAM_access_30$V_im) |> round(digits=2)`spatial availability).

```{r plot-figure5, out.width=600}
#| label: fig-Fig5
#| fig-cap: "The number of care destinations that can be reached, per DA, within 15 mins (top) and 30 mins (bottom) for the cumulative . Basemap shapefiles are retrieved from the 2021 Canadian census [@governmentofcanadaCensusPopulation2023], the Open Data Hamilton Portal [@opendatahamiltonCityBoundary2023] and the USGS [@greatlakesUSGS2010]."
knitr::include_graphics("figures/Fig5-plot_copp_Savail_measures.png")
```

When considering cumulative opportunity measure; three notable findings between modes can be identified. First, access by transit and walking is somewhat high (mostly Q3 and some Q4) within the core of Hamilton-Central but low elsewhere. This finding is somewhat expected as as transit does not significantly serve communities outside of Hamilton-Central and Dundas, and the density of walking infrastructure is
high in Hamilton-Central (see @fig-Fig1). Second, access by cycling is even higher (mostly Q3 but more Q4) in Hamilton-Central; it provides the second most opportunities for interactions after travel by car, and affords at least one opportunity for interaction in more DAs than walking and transit use (notably some access (Q1) in rural communities). Third, the access that the car-mode provides is significantly higher relative to the three sustainable modes. Travel by car results in the greatest maximum number of potential interactions to
care destinations (`r HAM_access_15$cum_opps |> max() |> round()` and `r HAM_access_30$cum_opps |> max() |> round()` opportunities within 15-min and 30-mins respectively). Car-mode offering high accessibility to care destinations is an expected outcome given the car-oriented design of North American cities [@saeidizandRevisitingCarDependency2022] and the range (travel speeds over a distance) of the car mode. However, though car ownership is high in Hamilton, not everyone has access to a private vehicle. For instance, `r (27831/sum(27831,82436,73454,20089,5768,1312,353,156,45,27,41)) |> scales::percent()` of Hamilton households do not own a car [@datamanagementgroupTTSTransportationTomorrow2018], presenting equity concerns in who may benefit from the high accessibility car-mode offers. The cumulative opportunities access is insightful in illustrating the range in which opportunities can be accessed by each mode based on their travel speed (on available infrastructure); a summary of each origins' modal opportunity isochrone. 

However, the cumulative opportunities measure does not account for competition effects. Namely, what proportion of the modal opportunity range is _spatially available_ to a mode-user at a given location when
competing for those same opportunities with other mode-users. Considering competition in this way conjures richer conclusions that reflects the mode-using population. For instance, consider cycling, a mode that offers a relatively high range but still smaller than the car. The cumulative opportunities values in  @fig-Fig5 reflects this intuition: Q3 and Q4 cumulative opportunities values are present for cycling in Hamilton-Central, offering the second best cumulative opportunities after the car. However, bike spatial availability values depicts a more complex story of opportunity accessibility: it reflect the mode's opportunity range as well as proportion of mode-using population and how their range relatively compares to all other modes. The bike-using population is small (`r ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode == "c_bike") |> mutate(bike_pop = Population*perc_cycle_other) |> dplyr::select(bike_pop) |> sum(na.rm=T)) / ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode == "a_car") |> dplyr::select(Population) |> sum(na.rm=T)))) |> scales::percent()` of the population), with many DAs having no or low proportions of bike-users. Meaning DAs with no bike-users are proportionally allocated no access to opportunities (zero spatial availability) and DAs with a small proportion of cyclists have relatively slow travel speeds compared to the car-using population. Though bike mode offers a relatively high opportunity range (cumulative opportunities), because of the low proportion of cyclist and their opportunity range compared to the _many_ other mode-users, they receive low spatial availability values.

Spatial availability values reflect the proportion of cumulative opportunities accessibility to the mode user (based on relative population and travel times), which can be used to shed light on what mode, and in what region, a mode-using population captures more than its equal share of spatial availability. Overall, `r ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode =="a_car") |> dplyr::select(V_im) |> sum()) / (HAM_access_30 |> sf::st_drop_geometry() |> dplyr::select(V_im) |> sum())) |> scales::percent()` of the spatial availability is taken by motorists (destinations within 30-minutes) but they only represent `r ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode == "a_car") |> mutate(car_pop = Population*perc_car) |> dplyr::select(car_pop) |> sum(na.rm=T)) / ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode == "a_car") |> dplyr::select(Population) |> sum(na.rm=T)))) |> scales::percent()` of the population. Therefore, they have disproportionately more availability than their population's presence in the city. Motorists capture this availability from populations that do not use cars, and as a result are left with lower
spatial availability. For instance, transit users that have access to destinations within 30-minutes represent `r ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode == "b_transit") |> mutate(transit_pop = Population*perc_transit) |> dplyr::select(transit_pop) |> sum(na.rm=T)) / ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode == "a_car") |> dplyr::select(Population) |> sum(na.rm=T)))) |> scales::percent()` of the population but claim only `r ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode =="b_transit") |> dplyr::select(V_im) |> sum()) / (HAM_access_30 |> sf::st_drop_geometry() |> dplyr::select(V_im) |> sum())) |> scales::percent(accuracy=1)` of the spatial availability. Similarly, though cyclists and pedestrians represent `r ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode == "c_bike") |> mutate(bike_pop = Population*perc_cycle_other) |> dplyr::select(bike_pop) |> sum(na.rm=T)) / ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode == "a_car") |> dplyr::select(Population) |> sum(na.rm=T)))) |> scales::percent()` and `r ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode == "d_walk") |> mutate(walk_pop = Population*perc_walked) |> dplyr::select(walk_pop) |> sum(na.rm=T)) / ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode == "a_car") |> dplyr::select(Population) |> sum(na.rm=T)))) |> scales::percent()` of the population respectively, they only capture `r ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode =="c_bike") |> dplyr::select(V_im) |> sum()) / (HAM_access_30 |> sf::st_drop_geometry() |> dplyr::select(V_im) |> sum())) |> scales::percent(accuracy=0.1)` (cyclist) and  `r ((HAM_access_30 |> sf::st_drop_geometry() |> filter(mode =="d_walk") |> dplyr::select(V_im) |> sum()) / (HAM_access_30 |> sf::st_drop_geometry() |> dplyr::select(V_im) |> sum())) |> scales::percent(accuracy=0.1)` (pedestrian) of the spatial availability. In other words, if certain mode-users capture a greater proportion of spatial availability, then there is less spatial availability remaining for other mode users. Spatial availability does not necessarily have to align with the cumulative opportunities that the mode offers, it is simply a constrained version that considers competition by mode-using populations. As noted, non-car modes have the potential to offer higher cumulative opportunities (within Hamilton-Central), but as it exists assuming modal commute shares, the majority of spatial availability to care destinations can still be
captured by motorists even in DAs where car mode share is under 50\% (such as Hamilton-Central, see proportions in @fig-Fig4.

Taken together, though non-car modes may provide somewhat good access to care destinations within Hamilton-Central (and some only some access in rural communities), they do not provide similar levels of available access (spatial availability). Car-using populations capture more spatial availability, even in the centre of Hamilton-Central, than all other modes. Note the lower number of Q3 and Q4 values within and radiating outwards from Hamilton-Central for non-car modes for cumulative opportunities measure compared to spatial availability. 

## Spatial availability and low-income mismatch

To draw insights on who may reside in DAs where populations are advantaged with higher modal spatial availability, a cross-tabulation is visualised in @fig-Fig6. The modal spatial availability is divided by the mode-using population in each DA, resulting in the rate of modal spatial availability. LICO prevalence is the proportion of population that falls below the low-income cutoff threshold (see @fig-Fig3). @fig-Fig6 can be interpreted as follows: residents who use a specific mode in a "yellow" area resides in a DA that offers below average spatial availability (i.e., below or equal to the the 50th percentile (median) levels of spatial availability per mode-using population) and the population within the DA has a high LICO-prevalence
(i.e, 80th percentile or higher (8.4\% or more)).

```{r plot-figure6, out.width=600}
#| label: fig-Fig6
#| fig-cap: "The spatial availability per mode-using-capita measure versus LICO prevelance, visualized for 15 mins (top) and 30 mins (bottom) travel time cutoffs. Basemap shapefiles are retrieved from the 2021 Canadian census [@governmentofcanadaCensusPopulation2023], the Open Data Hamilton Portal [@opendatahamiltonCityBoundary2023] and the USGS [@greatlakesUSGS2010]."
knitr::include_graphics("figures/Fig6-plot_Savail_smallv_LICO_measures.png")
```

Notice the green DAs for the car-driving population and presence of yellow DAs for non-car modes within Hamilton-Central: @fig-Fig6 reinforces findings from @fig-Fig5. Even in Hamilton-Central where there is a high proportion of LICO prevalence, car-mode using populations who reside in green DAs are offered high levels of spatial availability. However, due to financial constraints, car ownership is not always possible for low-income households. Lack of car ownership in areas with insufficient alternative modes hinders access to economic opportunities [@morrisDoesLackingCar2020; @kleinTransitionsOutCar2023]. For this reason, the introduction of policies that increase availability of care destination access for non-car modes could be considered. The majority of yellow DAs are concentrated in the centre of Hamilton-Central for cycling and walking populations. The mobility of care lens could be used to further examine policies that improve conditions that decrease LICO prevalence without displacing local residents, increase the number of accessible care destinations within Hamilton-Central, and make car-modes less spatially available (i.e., encourage modal shift, decrease travel times of non-car modes, and deprioritize decreasing car travel times).

# Discussion and conclusions

This paper is the first to conduct an exploratory multimodal accessibility analysis of Mobility of Care destinations -- one that counters the current literature's emphasis on employment-related destinations, a travel purpose more significant for men, and especially wealthy and educated men [@lawWomenTransportNew1999; @hansonGenderMobilityNew2010]. Its aim is to challenge current planning paradigms by explicitly focusing on care, vital and life-sustaining activities that are currently undervalued. This study also provides a tangible example of how one could conduct a gender-aware multimodal accessibility analyses, using the city of Hamilton as an empirical case study. In doing so, this paper contributes to the emergent mobility of care literature, that has focused on quantifying this underrepresented type of travel [@gomezvaroAccountingCareEveryday2023; @murillomunarCaregiversMoveGender2023; @ravensbergenExploratoryAnalysisMobility2022; @sanchezdemadariagaMobilityCareIntroducing2013; @sanchezdemadariagaMeasuringMobilitiesCare2019; @shumanCanMobilityCare2023] through rich and nuanced qualitative accounts of lived experiences completing mobility of care [@orjuelaReconsideringMobilityCare2023; @ravensbergenVelomobilitiesCareLowcycling2020; @sersliRidingAloneTogether2020]. 

This study also methodologically contributes to the accessibility literature by contrasting two multimodal accessibility measures: the widely used cumulative opportunities measure and the spatial availability measure, which offers accessibility insights on modal competition. The cumulative opportunities measure demonstrates the modal range of access by presenting the number of care destinations that each mode can reach within a 15- and 30- minute travel time threshold from each spatial location. Spatial availability constrains the cumulative opportunities measure by incorporating the _assumed_ proportions of mode-using populations and mode-specific travel times; this yields the number of care destinations that the mode-using population has access to out of all care destinations in the study region. The two measures communicate different insights about the case study: the study's results demonstrate that the car mode offers high cumulative opportunities access as well as exceptionally high spatial availability for motorists. While sustainable modes offer lower cumulative opportunities access (though higher in the city center) and, in certain areas, even lower spatial availability due to the disproportionately high spatial availability for the car users. In this way, relying only on the cumulative opportunities measure could provide an incomplete picture, as it does not reflect how the relatively large quantity of motorists and the greater range offered by the car can disproportionately claim more care destinations than non-car modes (pedestrians, cyclists, and transit) users. Although spatial availability offers a more complex picture of how modes provide access under competition, like other competitive measures, it relies on assumptions about who is "demanding" destinations. How those assumptions are made is a subject of ongoing discussion in the competitive accessibility literature [@merlinDoesCompetitionMatter2017; @kelobonyeMeasuringAccessibilitySpatial2020].

Further, this study contributes to the literature on equitable and sustainable transportation planning by providing a methodology to identify areas in need for further development. By highlighting how the car offers all-round high access and even higher spatial availability to care destinations in Hamilton, sustainable modes can be prioritized equitably. Previous research suggests that currently care trips are more frequently completed by car than by transit or bicycle as they often involve carrying things (e.g., groceries) or people (e.g., children) [@ravensbergenExploratoryAnalysisMobility2022]. Qualitative work supports this preference, citing convenience and increased safety as key reasons for choosing travel by car for care trips [@maciejewskaHaveChildrenThus2019; @carverParentalChauffeursWhat2013].

However, this study also highlights that the high spatial availability of motorists results in disproportionately low spatial availability for sustainable mode users, even in Hamilton-Central. While sustainability policies should aim to re-balance the spatial availability away from motorists to users of sustainable modes, these policies should incorporate an equity perspective that considers existing preferences in care trips. This study provides the stepping stones for such an equity lens in @fig-Fig6, by presenting a cross-tabulation of areas with high LICO prevalence and low spatial availability per sustainable-mode that could be the focus of policy intervention. Consider the cycling plot in @fig-Fig6, a factor driving the higher quantity of yellow DAs is the low proportion of cyclists assumed. This assumption holds in other Canadian contexts, cycling as a mode for care trips is also uncommon as cycling is uncommon  [@ravensbergenExploratoryAnalysisMobility2022]. Moreover, as care trips tend to be preformed by women, the low proportion of cycling for care trips has been put forth as a hypothesis to explain the gender-gap in cycling observed in low-cycling cities (like Hamilton) where only a third of cyclists are women [@ravensbergenFeministGeographiesCycling2019; @prati2018gender]. However, cycling as a mode has potential as it demonstrates high cumulative opportunities values. However, that potential is not being realized in part due to the low proportion of cyclists and the higher spatial availability values of motorists. Future research could examine what barriers those who conduct care trips are facing in regards to cycling, particularly focusing on the yellow areas indicated in @fig-Fig6.

## Study limitations

This study presents three types of limitations related to assumptions in the accessibility measure methods and data availability. First, since travel times from origin to care destination are unknown, they are estimated assuming a road network under free-flow conditions. While this affects the estimated travel times, research suggests that considering congested conditions may not significantly impact the resulting accessibility values [@yiannakouliasEstimatingEffectTurn2013]. In the context of Hamilton, road congestion is also more pertinent to car and transit modes than for pedestrians or cyclists. Second, using a binary uniform impedance function instead of a more complex distance-decay function could significantly affect accessibility results [@kapatsilaResolvingAccessibilityDilemma2023]. For instance, destinations beyond a 30-minute travel time could still be valued by people, and those within 5 and 15 minutes do not necessarily have the same importance. However, the use of the binary function trades complexity for interpretation, and this trade-off was made strategically to improve interpretability in the comparison between the two accessibility measures. To enhance reliability, two literature informed travel cost thresholds (15-minutes and 30-minutes) are selected. Third, the geometric centroids of DAs (origins) and destinations (all care destinations) were used as inputs for travel time calculations. This is a limitation as DAs were created for the purpose of the statistical census: they vary in area, and their centroids may not necessarily align with where that population may begin their journey to care destinations. This methodological decision presents limitations on how the travel time estimates can be interpreted to reflect actual travel times to care destinations.

Moreover, due to the exploratory nature of this research and novelty of the Mobility of Care concept, no research to date has directly captured the characteristics of mobility of care trips in Hamilton. The presented results thus are not calibrated to reflect observed mobility of care travel behaviour nor establish normative accessibility goals [@paezMeasuringAccessibilityPositive2012]. Travel behaviour data is needed to calibrate local destination-specific travel impedance cutoffs. For example, using a 15-minute cutoff for grocery-centric destinations and a 30-minute cutoff for health-centric destinations or assigning weights for each destination type as done in previous studies (e.g., a weight that reflects their "capacity" [@liMeasuringMultiactivities2024] or their "attractiveness" using origin-destination flows from travel surveys [@graellsCityCitiesMeasuring2021, @chengInvestigatingWalkingAccessibility2019]). In the absence of travel behaviour data and the use of uniform travel time thresholds and destination weights, the result's interpretation is limited to the access to _all_ care destinations within 15- or 30-minutes. It does not include the real individual socio-economic and intersectional characteristics that influence what destinations can be potentially accessed. Consequently, each destination is treated as a single opportunity, e.g., a school, a clinic, a hospital, and a grocery store are all equal to one opportunity each. Additionally, since care trip modal choice is unavailable at a disaggregated level for Hamilton, the commute mode choice is assumed for the spatial availability measure. This mode may not be what is used to visit care destinations and hence places a limitation on how the results should be interpreted.

Taken together, the discussion of these limitations presents room for future research to incorporate context-specific mobility of care travel surveys into accessibility analysis to more accurately reflect care accessibility landscapes. Future work could also look to disaggregate access to care by category and compare results to access to employment landscapes. This comparison could highlight the bias in planning toward jobs, as well as substantiate equity critiques.

# Data availability

All work is open, reproducible and completed in R [@Rcore]. A [GitHub repository](https://github.com/soukhova/Care-Destinations) hosts all associated data, text, figures and code, which relies on the following R packages: {knitr} [@knitr1], {biscale} [@biscale], {cancensus} [@cancensus], {cowplot} [@cowplot], {disk.frame} [@diskframe], {dplyr} [@dplyr], {flextable} [@flextable], {ftExtra} [@ftExtra], {ggplot2} [@ggplot2], {here} [@here], {mapview} [@mapview], {scales} [@scales], {sf} [@sf2], {tmap} [@tmap], {tmaptools} [@tmaptools], {renv} [@renv], {r5r} [@r5r], {rlang} [@rlang], and {rmarkdown} [@rmarkdown1].

# References

